<!DOCTYPE html>
<html lang="ko"
    xmlns:th="http://thymeleaf.org"
    xmlns:sec="http://thymeleaf.org/extras/spring-security"
>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>글작성</title>
    <script th:src="@{/js/jquery-3.7.1.min.js}"></script>
    <script>
        $(document).ready(function () {
            // 폼 제출 이벤트 제어 
            $("#Save").submit(function (event) {
                // 제목과 내용 입력 여부 확인
                var title = $("#title").val();
                var content = $("#content").val();
                var lat = $("#lat").val();
                var lng = $("#lng").val();
                var file = $("#file").val();
                if (title.trim() === "" || content.trim() === "" || lat.trim() === "" || lng.trim() === "" || file.trim() === ""){
                    alert("제목, 내용, 위치, 사진을 모두 입력해주세요.");
                    event.preventDefault(); // 폼 제출 방지
                }
            })
        })

        //올라오는 파일의 갯수를 제한하는 함수 
        function checkFileLimit(event) {
            // 사용자가 새로 선택한 파일들
            const newFiles = event.target.files;
            // 최대 업로드 갯수 제한
            const maxFiles = 5;
            
            // 미리보기 div 안에 이미 존재하는 이미지의 개수
            const existingFilesCount = document.querySelectorAll('.preview img').length;

            // 새로 선택한 파일들과 기존에 업로드된 파일들의 총합을 계산
            const totalFiles = existingFilesCount + newFiles.length;

            // 만약 총 파일 수가 최대 갯수를 초과하면 경고하고 막음
            if (totalFiles > maxFiles) {
                alert(`사진은 최대 ${maxFiles}장까지만 업로드할 수 있습니다.`);
                // 파일 선택 초기화 (선택된 파일을 지움)
                event.target.value = '';
                return;
            }
            // if 조건문에서 5개를 초과하지 않았을 경우 이미지 미리보기 함수 실행
            // files은 사용자가 업로드한 파일 목록이니 미리보기 이벤트의 파라미터로 가져간다.
            previewImages(newFiles);
        }

        //사진 미리보기 함수 
        function previewImages(files) {
            //미리보기 이미지를 넣을 div 클래스를 배열로 불러온다.
            const previewContainer = document.getElementsByClassName('preview');
            previewContainer.innerHTML = "";  // 기존 이미지 초기화

            for (let i = 0; i < files.length; i++) {
                const reader = new FileReader();
                // 파일을 읽는 작업을 완료한 후 이벤트 호출 
                reader.onload = function(e) {
                    //img 태그 생성 
                    const img = document.createElement('img');
                    // img 태그의 src 경로 정의 
                    img.src = e.target.result;
                    img.style.maxWidth = "100px";
                    img.style.margin = "10px";
                    //이미지를 미리 볼 div에 여러장의 사진을 넣는다. 
                    previewContainer[i].appendChild(img);
                }
                // 사용자가 선택한 파일을 미리 볼수 있도록 변환해주는 작업 시행
                reader.readAsDataURL(files[i]); 
            }
        }
    </script>
</head>
<body>
    <form id="Save" method="post" action="save" enctype="multipart/form-data">
        <p>제목 <input type="text" name="shareTitle" id="title"></p>
        <p>내용 <textarea type="text" name="shareContents" id="content"></textarea></p>
        <!-- 지도 태그 -->
        <div id="map" style="width:50%;height:350px;"></div>
        <p><em>지도를 클릭해주세요!</em></p> 
        
        <!-- 위도경도 태그 숨김처리-->
        <input type="hidden" name="shareLat" id="lat">
        <input type="hidden" name="shareLng" id="lng">

        <!-- 파일첨부 태그 이미지가 올라가면 올라온 이미지의 갯수를 확인하는 스크립트 함수를 실행 -->
        <p>사진첨부<input type="file" name="uploads" id="file" multiple onchange="checkFileLimit(event)"></p>
        <!-- 미리 보기 태그 -->
        <p class="preview"></p>
        <p class="preview"></p>
        <p class="preview"></p>
        <p class="preview"></p>
        <p class="preview"></p>
        <!-- form Save Controller 로 전송  -->
        <p><input type="submit" value="저장"></p>
    </form>

    <!-- 지도 자바스크립트 -->
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=488efa68a7500b0e2b513a8253d1f0c9"></script>
    <script>
        //gelocation으로 현재 위치 가져오기
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
            var mapContainer = document.getElementById('map'), // 지도를 표시할 div 
                mapOption = {                   //geolocation으로 가져온 현재 위치를 기준으로 지도 옵션 설정
                    center: new kakao.maps.LatLng(position.coords.latitude, position.coords.longitude   ), // 지도의 중심좌표
                    level: 4 // 지도의 확대 레벨
                };
            
            var map = new kakao.maps.Map(mapContainer, mapOption); // 지도를 생성합니다
            
            // 지도를 클릭한 위치에 표출할 마커입니다
            var marker = new kakao.maps.Marker({ 
                // 지도 중심좌표에 마커를 생성합니다 
                position: map.getCenter() 
            }); 
            // 지도에 마커를 표시합니다
            marker.setMap(map);
            
            // 지도에 클릭 이벤트를 등록합니다
            // 지도를 클릭하면 마지막 파라미터로 넘어온 함수를 호출합니다
            kakao.maps.event.addListener(map, 'click', function(mouseEvent) {        
                
                // 클릭한 위도, 경도 정보를 가져옵니다 
                var latlng = mouseEvent.latLng; 
                
                // 마커 위치를 클릭한 위치로 옮깁니다
                marker.setPosition(latlng);
                
                //form에 위도 경도값 값 넣어주기 
                $('#lat').val(latlng.getLat());
                $('#lng').val(latlng.getLng());
            });
        })
    };
    </script>
    
</body>
</html>