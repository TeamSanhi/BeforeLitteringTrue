<!DOCTYPE html>
<html lang="ko"
    xmlns:th="http://thymeleaf.org"
    xmlns:sec="http://thymeleaf.org/extras/spring-security"
>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>글읽기</title>
    <script th:src="@{/js/jquery-3.7.1.min.js}"></script>
    <!-- 게시글 수정 삭제, 북마크 처리 script -->
    <script>
        // 삭제 버튼 클릭 시 실행될 함수
        $(document).ready(function () {
            //게시글을 삭제하는 버튼 클릭이벤트 발생
            $('#deleteButton').click(del);
            // 게시글을 수정하는 버튼 클릭이벤트 발생
            $('#editButton').click(edit);
            // 북마크 버튼 클릭이벤트 실행 bookmark1 = 북 마크하지않음, bookmark
            $('#bookmark1, #bookmark2').click(bookmark);
            checkBookmark();
        })

        //삭제 함수
        function del(){
            //삭제여부 확인
            if(!confirm("정말 삭제하시겠습니까?")) return;
            //삭제할 글번호 가져오기
            let shareNum = $('#deleteButton').data('num');
            //ajax를 이용해서 삭제 요청 보내기
            $.ajax({
                url : 'delete',
                type : 'get',
                data : { shareNum : shareNum },
                success : function (result) {
                    alert("게시글을 삭제하였습니다.");
                    window.location.href = '/share/list'
                }
            })
        };

        //수정 함수
        function edit() {
            //수정여부확인
            if(confirm("정말 수정하시겠습니까?")){
                //수정할 글번호 가져오기
                let shareNum = $('#editButton').data('num')
                //수정할 경로 전송
                window.location.href = '/share/edit?shareNum=' + shareNum;
            }
        };

        // 게시글 상세보기 시 작성자가 게시글을 북마크 하고 있는지 아닌지 확인하는 함수 
        function checkBookmark() {
            var shareNum = $('#bookmark1').data('num'); // 게시글 번호 가져오기

            // 페이지 로드 시 북마크 상태 확인
            $.ajax({
                url: '/share/bookmark/check',  // 북마크 여부 확인을 위한 컨트롤러 URL
                type: 'get',
                data: { shareNum: shareNum },
                success: function(response) { // 서버로부터 true/false 값 받음
                    if (response) {
                        // 북마크되어 있다면 bookmark2를 보여주고 bookmark1을 숨김
                        $('#bookmark1').hide();
                        $('#bookmark2').show();
                    } else {
                        // 북마크가 안 되어 있다면 bookmark1을 보여주고 bookmark2를 숨김
                        $('#bookmark1').show();
                        $('#bookmark2').hide();
                    }
                },
            });

        }

        //북마크 버튼 클릭시 실행되는 함수
        function bookmark() {
            //data에 담겨있는 게시글 번호 가져옴 
            let shareNum = $(this).data('num'); 
            
            // ajax를 이용해 게시글 번호 전송 
            $.ajax({
                url:'bookmark',
                type: 'get',
                data: { shareNum : shareNum },
                success: function(response) { // 서버로부터 true/false 값 받음
                    if (response) {
                        // 북마크가 되어있다면 bookmark2를 보여주고 bookmark1을 숨김
                        $('#bookmark1').hide();
                        $('#bookmark2').show();
                    } else {
                        // 북마크가 안 되어있다면 bookmark1을 보여주고 bookmark2를 숨김
                        $('#bookmark1').show();
                        $('#bookmark2').hide();
                    }
                },
                // 로그인 하지 않음 사용자는 로그인 페이지로 이동하여
                error: function() {
                    alert("로그인하여 해주십시오");
                    window.location.href = '/login'; // 로그인 페이지로 리다이렉트
                }
            })
        }
    </script>
</head>
<body>
    <h1>나눠요 글읽기</h1>
    <table>
        <tr  style="height: 100px;">
            <th>제목</th>
            <th>내용</th>
            <th>닉네임</th>
            <th>작성일</th>
            <th>북마크</th>
        </tr>
        <tr>
            <td th:text="${shareBoard.shareTitle}"></td>
            <td th:text="${shareBoard.shareContents}"></td>
            <td th:text="${shareBoard.memberNickname}"></td>
            <!-- 타임리프 이용해 날짜 데이터 포멧 -->
            <td th:text="${#temporals.format(shareBoard.shareDate, 'yy년 MM월 dd일')}"></td>
            <!-- 북마크 기능 -->
            <td>
                <!-- 북마크 하지않았을때  -->
                <img id="bookmark1" th:data-num="${shareBoard.shareNum}" style="width: 40px; height: 40px;" src="/images/bookmark1.png">
                <!-- 북마크 하였을때  -->
                <img id="bookmark2" th:data-num="${shareBoard.shareNum}" style="width: 40px; height: 40px; display: none;"  src="/images/bookmark2.png">
            </td>
        </tr>
    </table>
    <!-- 이미지 경로를 설정하여 이미지를 다운로드하여 가져온다. -->
    <div th:each = "image : ${shareBoard.imageList}" style="display: inline-block;">      
            <img style="width: 200px; height: 200px;" th:src="|download?imageNum=${image.imageNum}|">
    </div>

    <!--지도 -->
    <div id="map" style="width:100%;height:350px;">
    </div>
    <!-- 위도 경도 정보 -->
    <input id="shareLat" type="hidden" th:value="${shareBoard.shareLat}">
    <input id="shareLng" type="hidden" th:value="${shareBoard.shareLng}">
    <!-- 게시글 거래위치 지도 스크립트  -->
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=488efa68a7500b0e2b513a8253d1f0c9"></script>
    <script>
        let shareLat = $('#shareLat').val();
        let shareLng = $('#shareLng').val();
        // 지도를 표시할 div 
        var mapContainer = document.getElementById('map'), 
            mapOption = { 
                center: new kakao.maps.LatLng(shareLat, shareLng), // 지도의 중심좌표
                level: 3 // 지도의 확대 레벨
            };
        var map = new kakao.maps.Map(mapContainer, mapOption); // 지도를 생성합니다
        // 마커가 표시될 위치입니다 
        var markerPosition  = new kakao.maps.LatLng(shareLat, shareLng); 
        // 마커를 생성합니다
        var marker = new kakao.maps.Marker({
            position: markerPosition
    });
    // 마커가 지도 위에 표시되도록 설정합니다
    marker.setMap(map);
    </script>

    <!-- 삭제 수정  -->
    <div>
        <!-- 로그인한 아이디와 게시글 작성자의 memberId가 같을때 삭제가 보이도록 한다.  -->
        <p th:if="${#authentication.name == shareBoard.memberId}">
            <button id="deleteButton" th:data-num="${shareBoard.shareNum}">삭제</button>
        </p>
        <!-- 로그인한 아이디와 게시글 작성자의 memberId가 같을때 수정이 보이도록 한다.  -->
        <p th:if="${#authentication.name == shareBoard.memberId}">
            <button id="editButton" th:data-num="${shareBoard.shareNum}">수정</button>
        </p>
    </div>
</body>
</html>