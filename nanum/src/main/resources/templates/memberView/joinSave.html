<!DOCTYPE html>
<html
  lang="ko"
  xmlns:th="http://thymeleaf.org"
  xmlns:sec="http://thymeleaf.org/extras/spring-security"
>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <style>
      /* 모달 스타일 */
      .modal {
        display: none;
        position: fixed;
        z-index: 1;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgb(0, 0, 0);
        background-color: rgba(0, 0, 0, 0.4);
      }
      .modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
      }
      .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
      }
      .close:hover,
      .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
      }
    </style>
    <script th:src="@{/js/jquery-3.7.1.min.js}"></script>
    <script>
      $(document).ready(function () {
        $("#idDuplicationCheck").val("");
        $("#nickDuplicationCheck").val("");

        // 아이디 중복 확인
        $("#idCheck").click(function () {
          let memberId = $("#memberId").val().trim();
          if (memberId === "") {
            alert("아이디를 입력하세요.");
            return;
          }
          $.get(`/find/idCheck`, { memberId: memberId }, function (data) {
            let message = data.available
              ? "사용 가능한 아이디입니다."
              : "아이디가 이미 존재합니다.";
            $("#idModalMessage").text(message);
            $("#idModal").show();
          });
        });

        // 닉네임 중복 확인
        $("#nickCheck").click(function () {
          let memberNickname = $("#memberNickname").val().trim();
          console.log(memberNickname);
          if (memberNickname === "") {
            alert("닉네임을 입력하세요.");
            return;
          }
          $.get(
            `/find/nickCheck`,
            { memberNickname: memberNickname },
            function (data) {
              let message = data.available
                ? "사용 가능한 닉네임입니다."
                : "닉네임이 이미 존재합니다.";
              $("#nickModalMessage").text(message);
              $("#nickModal").show();
            }
          );
        });

        // 모달 닫기
        $(".close").click(function () {
          $(this).parent().parent().hide();
        });
        $(window).click(function (event) {
          if ($(event.target).hasClass("modal")) {
            $(event.target).hide();
          }
        });

        // 아이디 중복 체크를 했는지 여부
        $("#idConfirm").click(function () {
          // 아이디 중복 확인 메시지가 "사용 가능한 아이디입니다."일 경우에만
          if ($("#idModalMessage").text() === "사용 가능한 아이디입니다.") {
            $("#idDuplicationCheck").val("y");
          } else {
            $("#idDuplicationCheck").val(""); // 중복된 경우 값을 비움
          }
          $("#idModal").hide();
        });

        // 닉네임 중복 체크를 했는지 여부
        $("#nickConfirm").click(function () {
          // 닉네임 중복 확인 메시지가 "사용 가능한 닉네임입니다."일 경우에만
          if ($("#nickModalMessage").text() === "사용 가능한 닉네임입니다.") {
            $("#nickDuplicationCheck").val("y");
          } else {
            $("#nickDuplicationCheck").val(""); // 중복된 경우 값을 비움
          }
          $("#nickModal").hide();
        });

        // 입력한 내용을 확인하고 DB에 저장
        $("#joinPost").submit(check);

        // 이메일을 사용해 인증번호 받는다.
        $("#emailButton").click(function () {
            const email = $("#memberEmail").val();
            $.ajax({
                url: '/sendEmail',
                type: 'POST',
                data: { email: email },
                success: function () {
                    alert("인증번호가 전송되었습니다.");
                },
                error: function () {
                    alert("이메일 전송에 실패했습니다.");
                }
            });
        });

         // 받은 인증번호를 확인한다. 
        $("#codeButton").click(function () {
            const inputCode = $("#emailCode").val();
            $.ajax({
                url: '/verifyCode',
                type: 'POST',
                data: { code: inputCode },
                success: function (response) {
                    alert(response.message);
                },
                error: function () {
                    alert("인증번호 확인에 실패했습니다.");
                }
            });
        });

      });

      // 아이디 입력 란에 영문만 입력 가능
      function onlyAlphaNum(input) {
        const regex = /^[A-Za-z0-9_]*$/; // 영문, 숫자, 언더바만 허용하는 정규 표현식
        if (!regex.test(input.value)) {
          // 입력된 값이 정규 표현식과 맞지 않으면 값을 수정
          input.value = input.value.replace(/[^A-Za-z0-9_]/g, "");
        }
      }

      function check() {
        let id = $("#memberId").val();
        let pw = $("#memberPw").val();
        let pwCheck = $("#pwCheck").val();
        let email = $("#memberEmail").val();
        let nickname = $("#memberNickname").val();
        let idDuplicationCheck = $("#idDuplicationCheck").val();
        let nickDuplicationCheck = $("#nickDuplicationCheck").val();

        if (id == "") {
          alert("아이디를 입력해주세요.");
          return false;
        }

        if (id.length < 4 || id.length > 12) {
          alert("아이디는 4자 이상 12자 이하로 입력해주세요.");
          return false;
        }

        if (pw == "") {
          alert("비밀번호를 입력해주세요.");
          return false;
        }

        if (pw.length < 8) {
          alert("비밀번호는 8자 이상으로 입력해주세요.");
          return false;
        }

        // if (email == "") {
        //   alert("이메일을 입력해주세요.");
        //   return false;
        // }

        if (nickname == "") {
          alert("닉네임을 입력해주세요.");
          return false;
        }

        if (pw != pwCheck) {
          alert("비밀번호가 일치하지 않습니다.");
          return false;
        }

        if (idDuplicationCheck != "y" || nickDuplicationCheck != "y") {
          alert("아이디 혹은 닉네임 중복 확인이 이루어지지 않았습니다");
          return false;
        }
      }
    </script>
  </head>
  <body>
    <h1>[ 회원 가입 ]</h1>
    <form th:action="@{/member/join}" method="post" id="joinPost">
      <table>
        <tr>
          <th>ID</th>
          <td>
            <!-- 아이디 입력창 -->
            <input
              type="text"
              name="memberId"
              id="memberId"
              maxlength="12"
              oninput="onlyAlphaNum(this)"
            />
            <!-- 아이디 중복 확인 (idCheck.html로 이동) -->
            <input type="button" id="idCheck" value="ID중복확인" />
          </td>
        </tr>

        <tr>
          <!-- 패스워드 입력창 -->
          <th>PW</th>
          <td>
            <input type="password" name="memberPw" id="memberPw" />
          </td>
        </tr>

        <tr>
          <!-- 패스워드 확인창 -->
          <th>PW 확인</th>
          <td><input type="password" id="pwCheck" /></td>
        </tr>

        <tr>
          <!-- 이메일 입력창 -->
          <th>이메일</th>
          <td>
            <input type="text" name="memberEmail" id="memberEmail" />
            <input type="button" value="인증번호 전송" id="emailButton" />
          </td>
        </tr>
        <tr>
          <!-- 이메일로 온 인증번호 입력창 -->
          <th>인증번호</th>
          <td>
            <input type="text" id="emailCode" />
            <input type="button" value="인증번호 확인" id="codeButton" />
          </td>
        </tr>
        <tr>
          <th>닉네임</th>
          <td>
            <!-- 닉네임 입력창 -->
            <input
              type="text"
              name="memberNickname"
              id="memberNickname"
              onkeyup="this.value=this.value.replace(' ','')"
            />
            <!-- 닉네임 중복 확인  -->
            <input type="button" value="닉네임중복확인" id="nickCheck" />
          </td>
        </tr>
      </table>
      <!-- ID중복확인했는지 여부 -->
      <input type="hidden" id="idDuplicationCheck" />
      <!-- 닉네임중복확인했는지 여부 -->
      <input type="hidden" id="nickDuplicationCheck" />
      <input type="submit" value="회원가입" id="postButton" />
    </form>

    <!-- ID 중복 확인 모달 -->
    <div id="idModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <p id="idModalMessage">아이디 중복 확인을 진행하세요.</p>
        <button id="idConfirm">확인</button>
      </div>
    </div>

    <!-- 닉네임 중복 확인 모달 -->
    <div id="nickModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <p id="nickModalMessage">닉네임 중복 확인을 진행하세요.</p>
        <button id="nickConfirm">확인</button>
      </div>
    </div>
  </body>
</html>
