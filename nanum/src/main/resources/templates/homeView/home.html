<!DOCTYPE html>
<html
  lang="ko"
  xmlns:th="http://www.thymeleaf.org"
  xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
>
  <head>
    <meta charset="UTF-8" />
    <title>Home Page</title>
    <style>
      .nav {
        display: flex;
        justify-content: space-between;
        gap: 20px;
        position: absolute;
        top: 10px;
        left: 10px;
      }

      .member {
        display: flex;
        justify-content: space-between;
        gap: 20px;
        position: absolute;
        top: 10px;
        right: 10px;
      }

      .footer {
        display: flex;
        justify-content: space-between;
        gap: 20px;
        position: absolute;
        bottom: 10px;
        left: 10px;
      }

      .modal {
        display: none; /* 모달을 숨김 */
        position: fixed; /* 화면에 고정된 위치로 설정 */
        z-index: 1; /* 다른 요소보다 앞에 오도록 설정 */
        left: 0; /* 화면 왼쪽부터 시작 */
        top: 0; /* 화면 상단부터 시작 */
        width: 100%; /* 화면 전체 너비 */
        height: 100%; /* 화면 전체 높이 */
        background-color: rgba(0, 0, 0, 0.5); /* 반투명한 검정색 배경 */
      }

      .modal-content {
        background-color: #fff;
        margin: 10% auto; /* 창 크기가 커질 경우, 위 여백을 줄일 수도 있음 */
        padding: 30px; /* 패딩을 늘려서 내부 콘텐츠 여백도 증가 */
        border: 1px solid #888;
        width: 90%; /* 너비를 화면의 90%로 변경 */
        max-width: 600px; /* 최대 너비를 600px로 확장 */
        text-align: center;
      }

      .message-room {
        border: 1px solid #ccc;
        padding: 10px;
        margin-bottom: 10px;
        cursor: pointer;
        background-color: #f9f9f9;
      }

      .message-room:hover {
        background-color: #e9e9e9;
      }

      /* .close 클래스는 모달의 닫기 버튼을 정의합니다. */
      .close {
        color: #aaa; /* 닫기 버튼의 기본 색상 */
        float: right; /* 닫기 버튼을 모달의 오른쪽 상단에 배치 */
        font-size: 28px; /* 닫기 버튼의 글자 크기 */
        font-weight: bold; /* 닫기 버튼의 글자 두께를 두껍게 설정 */
      }

      /* 닫기 버튼에 마우스를 올리거나 포커스할 때의 스타일을 정의합니다. */
      .close:hover,
      .close:focus {
        color: black; /* 닫기 버튼에 마우스를 올렸을 때 색상이 검정으로 변경 */
        text-decoration: none; /* 닫기 버튼의 밑줄 제거 */
        cursor: pointer; /* 닫기 버튼에 마우스를 올렸을 때 커서를 손 모양으로 변경 */
      }
    </style>
    <script th:src="@{/js/jquery-3.7.1.min.js}"></script>
    <script>
      $(document).ready(function () {
        // 쪽지 목록 열기 모달
        $("#messages").click(function () {
          $("#messagesModal").fadeIn();

          let memberNum = $("#messages").data("num");

          // 회원 번호를 통해 속한 쪽지방을 모두 가져옴
          $.ajax({
            url: "/message/rooms",
            method: "get",
            data: { memberNum: memberNum },
            success: function (data) {
              console.log("서버에서 반환된 데이터:", data);
              let messageList = "";
              data.forEach(function (room) {
                messageList += `
                  <div class="message-room" data-room="${
                    room.roomNum
                  }" data-share-num="${room.shareNum}">
                    <div>
                      <strong>게시글:</strong> ${room.shareTitle}
                    </div>
                    <div>
                      <strong>상대방:</strong> ${room.senderNickname}
                    </div>
                    <div>
                      <strong>메시지:</strong> ${
                        room.messageContents || "메시지가 없습니다."
                      }
                    </div>
                    <div>
                      <strong>시간:</strong> ${new Date(
                        room.deliverDate
                      ).toLocaleString()}
                    </div>
                  </div>`;
              });
              $("#messageListContainer").html(messageList);
            },
            error: function (xhr, status, error) {
              console.error("AJAX 요청 오류:", status, error);
            },
          });
        });

        // 쪽지방 클릭 시 상세보기 및 쪽지 전송 모달 표시
        $(document).on("click", ".message-room", function () {
          let roomNum = $(this).data("room");
          let userNum = $("#messages").data("num");
          console.log(roomNum, userNum);
          $("#detailsModal").fadeIn();

          // 쪽지 상세 내역 가져오기
          $.ajax({
            url: "/message/details",
            method: "GET",
            data: { roomNum: roomNum, userNum: userNum },
            success: function (data) {
              let detailsList = "";
              data.forEach(function (message) {
                detailsList += `
                  <div class="message-detail">
                    <strong>${message.senderNickname}:</strong> ${
                  message.messageContents
                }
                    <br/>
                    <small>${new Date(
                      message.deliverDate
                    ).toLocaleString()}</small>
                  </div>
                  <hr />`;
              });
              $("#messageDetailsContainer").html(detailsList);
            },
            error: function (xhr, status, error) {
              console.error("AJAX 요청 오류:", status, error);
            },
          });
        });

        // 메시지 보내기
        $("#sendMessageBtn").click(function () {
          let roomNum = $(".message-room").data("room");
          let messageContents = $("#messageInput").val();
          console.log("방번호:", roomNum, "내용:", messageContents);

          $.ajax({
            url: "/message/detailSend",
            method: "POST",
            data: { roomNum: roomNum, messageContents: messageContents },
            success: function (response) {
              $("#messageInput").val(""); // 입력 필드 초기화

              // 메시지 전송 후 상세 내역을 다시 가져오기
              $.ajax({
                url: "/message/details",
                method: "GET",
                data: { roomNum: roomNum, userNum: $("#messages").data("num") },
                success: function (data) {
                  let detailsList = "";
                  data.forEach(function (message) {
                    detailsList += `
              <div class="message-detail">
                <strong>${message.senderNickname}:</strong> ${
                      message.messageContents
                    }
                <br/>
                <small>${new Date(message.deliverDate).toLocaleString()}</small>
              </div>
              <hr />`;
                  });
                  $("#messageDetailsContainer").html(detailsList); // 상세 메시지 갱신
                },
                error: function (xhr, status, error) {
                  console.error("상세 메시지 가져오기 오류:", status, error);
                },
              });
            },
            error: function (xhr, status, error) {
              console.error("메시지 전송 오류:", status, error);
            },
          });
        });

        $("#messagesClose").click(function () {
          $("#messagesModal").fadeOut();
        });

        $("#detailsClose").click(function () {
          $("#detailsModal").fadeOut();
        });
        $(window).click(function (event) {
          if (
            $(event.target).is("#messagesModal") ||
            $(event.target).is("#detailsModal")
          ) {
            $("#messagesModal").fadeOut();
            $("#detailsModal").fadeOut();
          }
        });
      });
    </script>
  </head>
  <body>
    <div class="container">
      <!--  네비게이션 바  -->
      <div class="nav">
        <p><a href="">로고</a></p>
        <p><a th:href="@{/info/service}">우리는..</a></p>
        <p><a th:href="@{/share/list}">나눠요</a></p>
        <p><a th:href="@{/recycle/list}">버려요</a></p>
      </div>

      <!--  회원 기능  -->
      <div class="member">
        <th:block sec:authorize="not isAuthenticated()">
          <p>
            <a th:href="@{/member/join}">회원가입</a>
          </p>
          <p>
            <a th:href="@{/member/loginForm}">로그인</a>
          </p>
        </th:block>
        <th:block sec:authorize="isAuthenticated()">
          <p>
            <button
              id="messages"
              th:data-num="${#authentication.principal.num}"
            >
              쪽지
            </button>
          </p>

          <!-- 쪽지 목록 모달 -->
          <div id="messagesModal" class="modal">
            <div class="modal-content">
              <span id="messagesClose" class="close">&times;</span>
              <h2>나눔 이야기</h2>
              <div id="messageListContainer"></div>
            </div>
          </div>

          <!-- 쪽지 상세보기 모달 -->
          <div id="detailsModal" class="modal">
            <div class="modal-content">
              <span id="detailsClose" class="close">&times;</span>
              <h2>쪽지 상세보기</h2>
              <div id="messageDetailsContainer"></div>
              <textarea
                id="messageInput"
                placeholder="메시지를 입력하세요"
              ></textarea>
              <button id="sendMessageBtn">보내기</button>
              <button id="userReportBtn">신고하기</button>
            </div>
          </div>

          <p>
            <a th:href="@{/member/logout}">로그아웃</a>
          </p>
          <p>
            <a th:href="@{/myPage/view}">마이페이지</a>
          </p>
        </th:block>
      </div>

      <!--  사이트맵/FAQ  -->
      <div class="footer">
        <p><a th:href="@{/info/siteMap}" target="_blank">사이트맵</a></p>
        <p><a th:href="@{/info/faq}" target="_blank">FAQ</a></p>
      </div>
    </div>
  </body>
</html>
