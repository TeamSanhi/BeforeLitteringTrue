<!DOCTYPE html>
<html
  lang="ko"
  xmlns:th="http://www.thymeleaf.org"
  xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
>
  <head>
    <meta charset="UTF-8" />
    <title>Home Page</title>
    <style>
      .nav {
        display: flex;
        justify-content: space-between;
        gap: 20px;
        position: absolute;
        top: 10px;
        left: 10px;
      }

      .member {
        display: flex;
        justify-content: space-between;
        gap: 20px;
        position: absolute;
        top: 10px;
        right: 10px;
      }

      .footer {
        display: flex;
        justify-content: space-between;
        gap: 20px;
        position: absolute;
        bottom: 10px;
        left: 10px;
      }

      .modal {
        display: none; /* 모달을 숨김 */
        position: fixed; /* 화면에 고정된 위치로 설정 */
        z-index: 1; /* 다른 요소보다 앞에 오도록 설정 */
        left: 0; /* 화면 왼쪽부터 시작 */
        top: 0; /* 화면 상단부터 시작 */
        width: 100%; /* 화면 전체 너비 */
        height: 100%; /* 화면 전체 높이 */
        background-color: rgba(0, 0, 0, 0.5); /* 반투명한 검정색 배경 */
      }

      .modal-content {
        background-color: #fff;
        margin: 10% auto; /* 창 크기가 커질 경우, 위 여백을 줄일 수도 있음 */
        padding: 30px; /* 패딩을 늘려서 내부 콘텐츠 여백도 증가 */
        border: 1px solid #888;
        width: 90%; /* 너비를 화면의 90%로 변경 */
        max-width: 600px; /* 최대 너비를 600px로 확장 */
        text-align: center;
      }

      .message-room {
        border: 1px solid #ccc;
        padding: 10px;
        margin-bottom: 10px;
        cursor: pointer;
        background-color: #f9f9f9;
      }

      .message-room:hover {
        background-color: #e9e9e9;
      }

      /* .close 클래스는 모달의 닫기 버튼을 정의합니다. */
      .close {
        color: #aaa; /* 닫기 버튼의 기본 색상 */
        float: right; /* 닫기 버튼을 모달의 오른쪽 상단에 배치 */
        font-size: 28px; /* 닫기 버튼의 글자 크기 */
        font-weight: bold; /* 닫기 버튼의 글자 두께를 두껍게 설정 */
      }

      /* 닫기 버튼에 마우스를 올리거나 포커스할 때의 스타일을 정의합니다. */
      .close:hover,
      .close:focus {
        color: black; /* 닫기 버튼에 마우스를 올렸을 때 색상이 검정으로 변경 */
        text-decoration: none; /* 닫기 버튼의 밑줄 제거 */
        cursor: pointer; /* 닫기 버튼에 마우스를 올렸을 때 커서를 손 모양으로 변경 */
      }
    </style>
    <script th:src="@{/js/jquery-3.7.1.min.js}"></script>
    <script>
      $(document).ready(function () {
        // 읽지 않은 쪽지 개수 가져오기
        updateUnreadCount();

        // 쪽지 목록 열기 모달
        $("#messages").click(function () {
          $("#messagesModal").fadeIn();
          updateUnreadCount(); // 쪽지 모달 열릴 때마다 개수 업데이트

          let memberNum = $("#messages").data("num");

          // 회원 번호를 통해 속한 쪽지방을 모두 가져옴
          $.ajax({
            url: "/message/rooms",
            method: "get",
            data: { memberNum: memberNum },
            success: function (data) {
              console.log("서버에서 반환된 데이터:", data);
              let currentUserNum = $("#messages").data("num"); // 현재 로그인한 사용자의 번호
              let messageList = "";
              data.forEach(function (room) {
                console.log("발신자 번호 (senderNum):", room.senderNum);
                console.log(
                  "현재 사용자 번호 (currentUserNum):",
                  currentUserNum
                );

                // 쪽지를 보낸 사람이 현재 로그인한 사용자가 아니고, 읽지 않은 쪽지가 있을 때 'New!' 표시
                let newBadge =
                  room.hasUnreadMessages && room.senderNum !== currentUserNum
                    ? "<span style='color: red;'>New!</span>"
                    : "";

                messageList += `
                  <div class="message-room" data-room="${
                    room.roomNum
                  }" data-share-num="${room.shareNum}">
                    <div class="shareBoard" data-write="${
                      room.shareWriteNum
                    }" data-complete="${room.shareCompleted}">
                      <strong>게시글:</strong> ${room.shareTitle} ${newBadge} 
                    </div>
                    <div class="sender" data-num="${room.receiverNum}">
                      <strong>상대방:</strong> ${room.senderNickname}
                    </div>
                    <div>
                      <strong>메시지:</strong> ${
                        room.messageContents || "메시지가 없습니다."
                      }
                    </div>
                    <div>
                      <strong>시간:</strong> ${new Date(
                        room.deliverDate
                      ).toLocaleString()}
                    </div>
                  </div>`;
              });
              $("#messageListContainer").html(messageList);
            },
            error: function (xhr, status, error) {
              console.error("AJAX 요청 오류:", status, error);
            },
          });
        });

        // 쪽지방 클릭 시 상세보기 및 쪽지 전송 모달 표시
        $(document).on("click", ".message-room", function () {
          // 다른 방에서 active 클래스 제거
          $(".message-room").removeClass("active");
          // 현재 선택한 방에 active 클래스 추가
          $(this).addClass("active");

          let roomNum = $(this).data("room");
          let userNum = $("#messages").data("num");
          let shareNum = $(this).data("share-num");
          console.log(
            "방번호:",
            roomNum,
            "로그인한 유저번호:",
            userNum,
            "게시글 번호:",
            shareNum
          );
          $("#detailsModal").fadeIn();

          // 쪽지 상세 목록에서 게시글로 이동하는 클릭 이벤트
          $("#goToShareBoard").click(function () {
            let shareBoardUrl = `/share/read?shareNum=${shareNum}`; // 게시글 상세 페이지로 이동하는 URL
            window.open(shareBoardUrl, "_blank"); // 새 창에서 열기
          });

          // 쪽지 상세 내역 가져오기
          $.ajax({
            url: "/message/details",
            method: "GET",
            data: { roomNum: roomNum, userNum: userNum },
            success: function (data) {
              let detailsList = "";
              data.forEach(function (message) {
                detailsList += `
                  <div class="message-detail">
                    <strong>${message.senderNickname}:</strong> ${
                  message.messageContents
                }
                    <br/>
                    <small>${new Date(
                      message.deliverDate
                    ).toLocaleString()}</small>
                  </div>
                  <hr />`;
              });
              $("#messageDetailsContainer").html(detailsList);

              // 현재 선택한 방의 정보를 가져옴
              let selectedRoom = $(
                ".message-room[data-room='" + roomNum + "']"
              );
              let thisShareNum = parseInt(
                selectedRoom.find(".message-room").data("share-num")
              );
              let shareWriteNum = parseInt(
                selectedRoom.find(".shareBoard").data("write")
              );
              let shareCompletedData = selectedRoom
                .find(".shareBoard")
                .data("complete");
              let shareCompleted =
                shareCompletedData === true || shareCompletedData === "true";
              console.log(
                "게시글 번호:",
                thisShareNum,
                "게시글주인:",
                shareWriteNum,
                "완료여부:",
                shareCompleted
              );
              // 나눔 완료 버튼 표시 및 비활성화 설정
              if (userNum === shareWriteNum) {
                $("#shareComplete").show();

                if (shareCompleted) {
                  $("#shareComplete").prop("disabled", true);
                } else {
                  $("#shareComplete").prop("disabled", false);
                }
              } else {
                $("#shareComplete").hide();
              }
            },
            error: function (xhr, status, error) {
              console.error("AJAX 요청 오류:", status, error);
            },
          });
        });

        // 메시지 보내기
        $("#sendMessageBtn").click(function () {
          let roomNum = $(".message-room.active").data("room");
          let messageContents = $("#messageInput").val();
          console.log("방번호:", roomNum, "내용:", messageContents);

          $.ajax({
            url: "/message/detailSend",
            method: "POST",
            data: { roomNum: roomNum, messageContents: messageContents },
            success: function (response) {
              $("#messageInput").val(""); // 입력 필드 초기화

              // 메시지 전송 후 상세 내역을 다시 가져오기
              $.ajax({
                url: "/message/details",
                method: "GET",
                data: { roomNum: roomNum, userNum: $("#messages").data("num") },
                success: function (data) {
                  let detailsList = "";
                  data.forEach(function (message) {
                    detailsList += `
              <div class="message-detail">
                <strong>${message.senderNickname}:</strong> ${
                      message.messageContents
                    }
                <br/>
                <small>${new Date(message.deliverDate).toLocaleString()}</small>
              </div>
              <hr />`;
                  });
                  $("#messageDetailsContainer").html(detailsList); // 상세 메시지 갱신
                },
                error: function (xhr, status, error) {
                  console.error("상세 메시지 가져오기 오류:", status, error);
                },
              });
            },
            error: function (xhr, status, error) {
              console.error("메시지 전송 오류:", status, error);
            },
          });
        });

        // 나눔 이야기 닫기
        $("#messagesClose").click(function () {
          $("#messagesModal").fadeOut();
          updateUnreadCount(); // 모달 닫을 때 안 읽은 쪽지 개수 업데이트
        });

        // 쪽지 상세내역 닫기
        $("#detailsClose").click(function () {
          $("#detailsModal").fadeOut();
          // 쪽지 목록 갱신을 위해 다시 목록 불러오기
          updateMessageRooms();
        });

        $(window).click(function (event) {
          if (
            $(event.target).is("#messagesModal") ||
            $(event.target).is("#detailsModal")
          ) {
            $("#messagesModal").fadeOut();
            $("#detailsModal").fadeOut();
            updateUnreadCount(); // 모달 닫을 때 안 읽은 쪽지 개수 업데이트
            // 쪽지 목록 갱신을 위해 다시 목록 불러오기
            updateMessageRooms();
          }
        });

        // 쪽지에서 '신고하기' 버튼 클릭 시 신고 모달 열기
        $("#userReportBtn").click(function () {
          $("#reportModal").show();
        });

        // 신고 모달 닫기
        $(".close").click(function () {
          $("#reportModal").hide();
        });

        // 모달 창 바깥 부분을 클릭하면 모달 창 닫기
        $(window).click(function (event) {
          if ($(event.target).is("#reportModal")) {
            $("#reportModal").hide();
          }
        });

        // 신고 제출 버튼 클릭 시 신고 내역 제출
        $("#submitUserReportBtn").click(function () {
          submitReport();
        });

        // 나눔 완료 버튼 클릭 시
        $("#shareComplete").click(function () {
          let shareNum = $(".message-room.active").data("share-num");
          let receiverNum = $(".message-room.active")
            .find(".sender")
            .data("num");
          console.log("게시글:", shareNum, "받는사람:", receiverNum);

          $.ajax({
            url: "/share/complete",
            method: "POST",
            data: { shareNum: shareNum, receiverNum: receiverNum },
            success: function (response) {
              alert("나눔이 완료되었습니다.");
              $("#shareComplete").prop("disabled", true); // 버튼 비활성화
              // 나눔 완료 후 쪽지 목록 갱신
              let memberNum = $("#messages").data("num");
              $.ajax({
                url: "/message/rooms",
                method: "get",
                data: { memberNum: memberNum },
                success: function (data) {
                  let messageList = "";
                  data.forEach(function (room) {
                    messageList += `
              <div class="message-room" data-room="${
                room.roomNum
              }" data-share-num="${room.shareNum}">
                <div class="shareBoard" data-write="${
                  room.shareWriteNum
                }" data-complete="${room.shareCompleted}">
                  <strong>게시글:</strong> ${room.shareTitle}
                </div>
                <div class="sender" data-num="${room.receiverNum}">
                  <strong>상대방:</strong> ${room.senderNickname}
                </div>
                <div>
                  <strong>메시지:</strong> ${
                    room.messageContents || "메시지가 없습니다."
                  }
                </div>
                <div>
                  <strong>시간:</strong> ${new Date(
                    room.deliverDate
                  ).toLocaleString()}
                </div>
              </div>`;
                  });
                  $("#messageListContainer").html(messageList);
                },
                error: function (xhr, status, error) {
                  console.error("AJAX 요청 오류:", status, error);
                },
              });
            },
            error: function () {
              alert("나눔 완료 처리 중 오류가 발생했습니다.");
            },
          });
        });
      });

      // 신고 데이터 전송 함수
      function submitReport() {
        let reportReasons = [];
        $("input[name='reportReason']:checked").each(function () {
          reportReasons.push($(this).val());
        });
        let additionalReason = $("#additionalReason").val();
        let shareNum = $(".message-room.active").data("share-num");
        let reporterNum = $("#messages").data("num"); // 사용자의 ID
        let memberNum = $(".message-room.active").find(".sender").data("num"); // 상대 ID

        console.log(
          "사유:",
          additionalReason,
          "게시글번호:",
          shareNum,
          "나:",
          reporterNum,
          "신고당한 사람:",
          memberNum
        );
        // Ajax 요청으로 신고 데이터 전송
        $.ajax({
          url: "/report/submit",
          type: "post",
          data: {
            memberNum: memberNum,
            reporterNum: reporterNum,
            reportReason: JSON.stringify(reportReasons),
            additionalReason: additionalReason,
            shareNum: shareNum,
          },
          success: function (response) {
            alert("신고가 접수되었습니다.");
            $("#reportModal").hide();
          },
          error: function (xhr) {
            if (xhr.status === 409) {
              // Conflict 상태일 때
              alert(xhr.responseText); // 이미 신고한 유저에 대한 메시지 출력
            } else {
              alert("신고 처리 중 오류가 발생했습니다.");
            }
          },
        });
      }

      function updateUnreadCount() {
        let memberNum = $("#messages").data("num");
        console.log("로그인한 번호:", memberNum);
        $.ajax({
          url: "/message/rooms/unreadCount/" + memberNum, // 현재 로그인한 사용자의 쪽지 개수 API 호출
          method: "get",
          success: function (count) {
            $("#badge").text(`(${count})`); // 읽지 않은 쪽지 개수를 badge에 업데이트
          },
          error: function (xhr, status, error) {
            console.error("읽지 않은 쪽지 개수 가져오기 오류:", status, error);
          },
        });
      }

      function updateMessageRooms() {
        let memberNum = $("#messages").data("num");

        $.ajax({
          url: "/message/rooms",
          method: "get",
          data: { memberNum: memberNum },
          success: function (data) {
            console.log("갱신된 쪽지방 데이터:", data);
            let currentUserNum = $("#messages").data("num"); // 현재 로그인한 사용자의 번호
            let messageList = "";
            data.forEach(function (room) {
              // 쪽지를 보낸 사람이 현재 로그인한 사용자가 아니고, 읽지 않은 쪽지가 있을 때 'New!' 표시
              let newBadge =
                room.hasUnreadMessages && room.senderNum !== currentUserNum
                  ? "<span style='color: red;'>New!</span>"
                  : "";

              messageList += `
                  <div class="message-room" data-room="${
                    room.roomNum
                  }" data-share-num="${room.shareNum}">
                    <div class="shareBoard" data-write="${
                      room.shareWriteNum
                    }" data-complete="${room.shareCompleted}">
                      <strong>게시글:</strong> ${room.shareTitle} ${newBadge}
                    </div>
                    <div class="sender" data-num="${room.receiverNum}">
                      <strong>상대방:</strong> ${room.senderNickname}
                    </div>
                    <div>
                      <strong>메시지:</strong> ${
                        room.messageContents || "메시지가 없습니다."
                      }
                    </div>
                    <div>
                      <strong>시간:</strong> ${new Date(
                        room.deliverDate
                      ).toLocaleString()}
                    </div>
                  </div>`;
            });
            $("#messageListContainer").html(messageList);
          },
          error: function (xhr, status, error) {
            console.error("AJAX 요청 오류:", status, error);
          },
        });
      }
    </script>
  </head>
  <body>
    <div class="container">
      <!--  네비게이션 바  -->
      <div class="nav">
        <p><a href="">로고</a></p>
        <p><a th:href="@{/info/service}">우리는..</a></p>
        <p><a th:href="@{/share/list}">나눠요</a></p>
        <p><a th:href="@{/recycle/list}">버려요</a></p>
      </div>

      <!--  회원 기능  -->
      <div class="member">
        <th:block sec:authorize="not isAuthenticated()">
          <p>
            <a th:href="@{/member/join}">회원가입</a>
          </p>
          <p>
            <a th:href="@{/member/loginForm}">로그인</a>
          </p>
        </th:block>
        <th:block sec:authorize="isAuthenticated()">
          <!--/* <p>
            <button
              id="messages"
              th:data-num="${#authentication.principal.num}"
            >
              쪽지
            </button>
          </p> */-->
          <div
            class="message"
            id="messages"
            th:data-num="${#authentication.principal.num}"
          >
            <span class="messageHover">
              나눔 이야기&nbsp;<span class="badge" id="badge">(0)</span>
              <!-- 알림 기본값 0 -->
            </span>
          </div>

          <!-- 쪽지 목록 모달 -->
          <div
            id="messagesModal"
            class="modal"
            style="
              max-height: calc(100vh - 50px);
              overflow-x: hidden;
              overflow-y: auto;
            "
          >
            <div class="modal-content">
              <span id="messagesClose" class="close">&times;</span>
              <h2>나눔 이야기</h2>
              <div id="messageListContainer"></div>
            </div>
          </div>

          <!-- 쪽지 상세보기 모달 -->
          <div
            id="detailsModal"
            class="modal"
            style="
              max-height: calc(100vh - 50px);
              overflow-x: hidden;
              overflow-y: auto;
            "
          >
            <div class="modal-content">
              <span id="detailsClose" class="close">&times;</span>
              <h2>쪽지 상세보기</h2>

              <!-- 게시글로 이동하는 영역 추가 -->
              <div id="goToShareBoard" style="cursor: pointer">
                <div
                  id="shareBoardLink"
                  style="
                    padding: 10px;
                    border: 1px solid #ccc;
                    text-align: center;
                  "
                >
                  게시글로 이동
                </div>
              </div>
              <div id="messageDetailsContainer"></div>
              <textarea
                id="messageInput"
                placeholder="메시지를 입력하세요"
              ></textarea>
              <button id="sendMessageBtn">보내기</button>
              <button id="userReportBtn">신고하기</button>
              <button id="shareComplete" style="display: none">
                나눔 완료
              </button>
            </div>
          </div>

          <!-- 게시글 유저 신고 모달창 -->
          <div id="reportModal" class="modal">
            <div class="modal-content">
              <span class="close">&times;</span>
              <h2>신고하기</h2>
              <form id="reportForm">
                <div>
                  <label
                    ><input
                      type="checkbox"
                      name="reportReason"
                      value="욕설, 인신공격 등 언어적 폭력"
                    />
                    욕설, 인신공격 등 언어적 폭력</label
                  >
                  <label
                    ><input
                      type="checkbox"
                      name="reportReason"
                      value="부적절한 게시글"
                    />
                    부적절한 게시글</label
                  >
                  <label
                    ><input
                      type="checkbox"
                      name="reportReason"
                      value="사기 또는 허위정보"
                    />
                    사기 또는 허위정보</label
                  >
                  <label
                    ><input type="checkbox" name="reportReason" value="기타" />
                    기타</label
                  >
                </div>
                <textarea
                  id="additionalReason"
                  placeholder="기타 사유를 입력하세요"
                ></textarea
                ><br />
                <button type="button" id="submitUserReportBtn">
                  신고 제출
                </button>
              </form>
            </div>
          </div>

          <p>
            <a th:href="@{/member/logout}">로그아웃</a>
          </p>
          <p>
            <a th:href="@{/myPage/view}">마이페이지</a>
          </p>
        </th:block>
      </div>

      <!--  사이트맵/FAQ  -->
      <div class="footer">
        <p><a th:href="@{/info/siteMap}" target="_blank">사이트맵</a></p>
        <p><a th:href="@{/info/faq}" target="_blank">FAQ</a></p>
      </div>
    </div>
  </body>
</html>
