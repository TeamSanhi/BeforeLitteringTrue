<!DOCTYPE html>
<html
  lang="ko"
  xmlns:th="http://www.thymeleaf.org"
  xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
>
  <head>
    <meta charset="UTF-8" />
    <title>Home Page</title>
    <!-- Style -->
    <link rel="stylesheet" href="/css/home.css">
    <style>

    </style>
    <!-- script -->
    <script th:src="@{/js/jquery-3.7.1.min.js}"></script>
    <script type="text/javascript" src="/js/home.js"></script>
    <script>
      $(document).ready(function () {
        // 읽지 않은 쪽지 개수 가져오기
        updateUnreadCount();

        // 쪽지 목록 열기 모달
        $("#messages").click(function () {
          $("#messagesModal").fadeIn();
          updateUnreadCount(); // 쪽지 모달 열릴 때마다 개수 업데이트

          let memberNum = $("#messages").data("num");

          // 회원 번호를 통해 속한 쪽지방을 모두 가져옴
          $.ajax({
            url: "/message/rooms",
            method: "get",
            data: { memberNum: memberNum },
            success: function (data) {
              console.log("서버에서 반환된 데이터:", data);
              let currentUserNum = $("#messages").data("num"); // 현재 로그인한 사용자의 번호
              let messageList = "";
              data.forEach(function (room) {
                console.log("발신자 번호 (senderNum):", room.senderNum);
                console.log(
                  "현재 사용자 번호 (currentUserNum):",
                  currentUserNum
                );

                // 쪽지를 보낸 사람이 현재 로그인한 사용자가 아니고, 읽지 않은 쪽지가 있을 때 'New!' 표시
                let newBadge =
                  room.hasUnreadMessages && room.senderNum !== currentUserNum
                    ? "<span style='color: red;'>New!</span>"
                    : "";

                messageList += `
                  <div class="message-room" data-room="${
                    room.roomNum
                  }" data-share-num="${room.shareNum}">
                    <div class="shareBoard" data-write="${
                      room.shareWriteNum
                    }" data-complete="${room.shareCompleted}">
                      <strong>게시글:</strong> ${room.shareTitle} ${newBadge} 
                    </div>
                    <div class="sender" data-num="${room.receiverNum}">
                      <strong>상대방:</strong> ${room.senderNickname}
                    </div>
                    <div>
                      <strong>메시지:</strong> ${
                        room.messageContents || "메시지가 없습니다."
                      }
                    </div>
                    <div>
                      <strong>시간:</strong> ${new Date(
                        room.deliverDate
                      ).toLocaleString()}
                    </div>
                  </div>`;
              });
              $("#messageListContainer").html(messageList);
            },
            error: function (xhr, status, error) {
              console.error("AJAX 요청 오류:", status, error);
            },
          });
        });

        // 쪽지방 클릭 시 상세보기 및 쪽지 전송 모달 표시
        $(document).on("click", ".message-room", function () {
          // 다른 방에서 active 클래스 제거
          $(".message-room").removeClass("active");
          // 현재 선택한 방에 active 클래스 추가
          $(this).addClass("active");

          let roomNum = $(this).data("room");
          let userNum = $("#messages").data("num");
          let shareNum = $(this).data("share-num");
          console.log(
            "방번호:",
            roomNum,
            "로그인한 유저번호:",
            userNum,
            "게시글 번호:",
            shareNum
          );
          $("#detailsModal").fadeIn();

          // 쪽지 상세 목록에서 게시글로 이동하는 클릭 이벤트
          $("#goToShareBoard").click(function () {
            let shareBoardUrl = `/share/read?shareNum=${shareNum}`; // 게시글 상세 페이지로 이동하는 URL
            window.open(shareBoardUrl, "_blank"); // 새 창에서 열기
          });

          // 쪽지 상세 내역 가져오기
          $.ajax({
            url: "/message/details",
            method: "GET",
            data: { roomNum: roomNum, userNum: userNum },
            success: function (data) {
              let detailsList = "";
              data.forEach(function (message) {
                detailsList += `
                  <div class="message-detail">
                    <strong>${message.senderNickname}:</strong> ${
                  message.messageContents
                }
                    <br/>
                    <small>${new Date(
                      message.deliverDate
                    ).toLocaleString()}</small>
                  </div>
                  <hr />`;
              });
              $("#messageDetailsContainer").html(detailsList);

              // 현재 선택한 방의 정보를 가져옴
              let selectedRoom = $(
                ".message-room[data-room='" + roomNum + "']"
              );
              let thisShareNum = parseInt(
                selectedRoom.find(".message-room").data("share-num")
              );
              let shareWriteNum = parseInt(
                selectedRoom.find(".shareBoard").data("write")
              );
              let shareCompletedData = selectedRoom
                .find(".shareBoard")
                .data("complete");
              let shareCompleted =
                shareCompletedData === true || shareCompletedData === "true";
              console.log(
                "게시글 번호:",
                thisShareNum,
                "게시글주인:",
                shareWriteNum,
                "완료여부:",
                shareCompleted
              );
              // 나눔 완료 버튼 표시 및 비활성화 설정
              if (userNum === shareWriteNum) {
                $("#shareComplete").show();

                if (shareCompleted) {
                  $("#shareComplete").prop("disabled", true);
                } else {
                  $("#shareComplete").prop("disabled", false);
                }
              } else {
                $("#shareComplete").hide();
              }
            },
            error: function (xhr, status, error) {
              console.error("AJAX 요청 오류:", status, error);
            },
          });
        });

        // 메시지 보내기
        $("#sendMessageBtn").click(function () {
          let roomNum = $(".message-room.active").data("room");
          let messageContents = $("#messageInput").val();
          console.log("방번호:", roomNum, "내용:", messageContents);

          $.ajax({
            url: "/message/detailSend",
            method: "POST",
            data: { roomNum: roomNum, messageContents: messageContents },
            success: function (response) {
              $("#messageInput").val(""); // 입력 필드 초기화

              // 메시지 전송 후 상세 내역을 다시 가져오기
              $.ajax({
                url: "/message/details",
                method: "GET",
                data: { roomNum: roomNum, userNum: $("#messages").data("num") },
                success: function (data) {
                  let detailsList = "";
                  data.forEach(function (message) {
                    detailsList += `
              <div class="message-detail">
                <strong>${message.senderNickname}:</strong> ${
                      message.messageContents
                    }
                <br/>
                <small>${new Date(message.deliverDate).toLocaleString()}</small>
              </div>
              <hr />`;
                  });
                  $("#messageDetailsContainer").html(detailsList); // 상세 메시지 갱신
                },
                error: function (xhr, status, error) {
                  console.error("상세 메시지 가져오기 오류:", status, error);
                },
              });
            },
            error: function (xhr, status, error) {
              console.error("메시지 전송 오류:", status, error);
            },
          });
        });

        // 나눔 이야기 닫기
        $("#messagesClose").click(function () {
          $("#messagesModal").fadeOut();
          updateUnreadCount(); // 모달 닫을 때 안 읽은 쪽지 개수 업데이트
        });

        // 쪽지 상세내역 닫기
        $("#detailsClose").click(function () {
          $("#detailsModal").fadeOut();
          // 쪽지 목록 갱신을 위해 다시 목록 불러오기
          updateMessageRooms();
        });

        $(window).click(function (event) {
          if (
            $(event.target).is("#messagesModal") ||
            $(event.target).is("#detailsModal")
          ) {
            $("#messagesModal").fadeOut();
            $("#detailsModal").fadeOut();
            updateUnreadCount(); // 모달 닫을 때 안 읽은 쪽지 개수 업데이트
            // 쪽지 목록 갱신을 위해 다시 목록 불러오기
            updateMessageRooms();
          }
        });

        // 쪽지에서 '신고하기' 버튼 클릭 시 신고 모달 열기
        $("#userReportBtn").click(function () {
          $("#reportModal").show();
        });

        // 신고 모달 닫기
        $(".close").click(function () {
          $("#reportModal").hide();
        });

        // 모달 창 바깥 부분을 클릭하면 모달 창 닫기
        $(window).click(function (event) {
          if ($(event.target).is("#reportModal")) {
            $("#reportModal").hide();
          }
        });

        // 신고 제출 버튼 클릭 시 신고 내역 제출
        $("#submitUserReportBtn").click(function () {
          submitReport();
        });

        // 나눔 완료 버튼 클릭 시
        $("#shareComplete").click(function () {
          let shareNum = $(".message-room.active").data("share-num");
          let receiverNum = $(".message-room.active")
            .find(".sender")
            .data("num");
          console.log("게시글:", shareNum, "받는사람:", receiverNum);

          $.ajax({
            url: "/share/complete",
            method: "POST",
            data: { shareNum: shareNum, receiverNum: receiverNum },
            success: function (response) {
              alert("나눔이 완료되었습니다.");
              $("#shareComplete").prop("disabled", true); // 버튼 비활성화
              // 나눔 완료 후 쪽지 목록 갱신
              let memberNum = $("#messages").data("num");
              $.ajax({
                url: "/message/rooms",
                method: "get",
                data: { memberNum: memberNum },
                success: function (data) {
                  let messageList = "";
                  data.forEach(function (room) {
                    messageList += `
              <div class="message-room" data-room="${
                room.roomNum
              }" data-share-num="${room.shareNum}">
                <div class="shareBoard" data-write="${
                  room.shareWriteNum
                }" data-complete="${room.shareCompleted}">
                  <strong>게시글:</strong> ${room.shareTitle}
                </div>
                <div class="sender" data-num="${room.receiverNum}">
                  <strong>상대방:</strong> ${room.senderNickname}
                </div>
                <div>
                  <strong>메시지:</strong> ${
                    room.messageContents || "메시지가 없습니다."
                  }
                </div>
                <div>
                  <strong>시간:</strong> ${new Date(
                    room.deliverDate
                  ).toLocaleString()}
                </div>
              </div>`;
                  });
                  $("#messageListContainer").html(messageList);
                },
                error: function (xhr, status, error) {
                  console.error("AJAX 요청 오류:", status, error);
                },
              });
            },
            error: function () {
              alert("나눔 완료 처리 중 오류가 발생했습니다.");
            },
          });
        });
      });

      // 신고 데이터 전송 함수
      function submitReport() {
        let reportReasons = [];
        $("input[name='reportReason']:checked").each(function () {
          reportReasons.push($(this).val());
        });
        let additionalReason = $("#additionalReason").val();
        let shareNum = $(".message-room.active").data("share-num");
        let reporterNum = $("#messages").data("num"); // 사용자의 ID
        let memberNum = $(".message-room.active").find(".sender").data("num"); // 상대 ID

        console.log(
          "사유:",
          additionalReason,
          "게시글번호:",
          shareNum,
          "나:",
          reporterNum,
          "신고당한 사람:",
          memberNum
        );
        // Ajax 요청으로 신고 데이터 전송
        $.ajax({
          url: "/report/submit",
          type: "post",
          data: {
            memberNum: memberNum,
            reporterNum: reporterNum,
            reportReason: JSON.stringify(reportReasons),
            additionalReason: additionalReason,
            shareNum: shareNum,
          },
          success: function (response) {
            alert("신고가 접수되었습니다.");
            $("#reportModal").hide();
          },
          error: function (xhr) {
            if (xhr.status === 409) {
              // Conflict 상태일 때
              alert(xhr.responseText); // 이미 신고한 유저에 대한 메시지 출력
            } else {
              alert("신고 처리 중 오류가 발생했습니다.");
            }
          },
        });
      }

      function updateUnreadCount() {
        let memberNum = $("#messages").data("num");
        console.log("로그인한 번호:", memberNum);
        $.ajax({
          url: "/message/rooms/unreadCount/" + memberNum, // 현재 로그인한 사용자의 쪽지 개수 API 호출
          method: "get",
          success: function (count) {
            $("#badge").text(`(${count})`); // 읽지 않은 쪽지 개수를 badge에 업데이트
          },
          error: function (xhr, status, error) {
            console.error("읽지 않은 쪽지 개수 가져오기 오류:", status, error);
          },
        });
      }

      function updateMessageRooms() {
        let memberNum = $("#messages").data("num");

        $.ajax({
          url: "/message/rooms",
          method: "get",
          data: { memberNum: memberNum },
          success: function (data) {
            console.log("갱신된 쪽지방 데이터:", data);
            let currentUserNum = $("#messages").data("num"); // 현재 로그인한 사용자의 번호
            let messageList = "";
            data.forEach(function (room) {
              // 쪽지를 보낸 사람이 현재 로그인한 사용자가 아니고, 읽지 않은 쪽지가 있을 때 'New!' 표시
              let newBadge =
                room.hasUnreadMessages && room.senderNum !== currentUserNum
                  ? "<span style='color: red;'>New!</span>"
                  : "";

              messageList += `
                  <div class="message-room" data-room="${
                    room.roomNum
                  }" data-share-num="${room.shareNum}">
                    <div class="shareBoard" data-write="${
                      room.shareWriteNum
                    }" data-complete="${room.shareCompleted}">
                      <strong>게시글:</strong> ${room.shareTitle} ${newBadge}
                    </div>
                    <div class="sender" data-num="${room.receiverNum}">
                      <strong>상대방:</strong> ${room.senderNickname}
                    </div>
                    <div>
                      <strong>메시지:</strong> ${
                        room.messageContents || "메시지가 없습니다."
                      }
                    </div>
                    <div>
                      <strong>시간:</strong> ${new Date(
                        room.deliverDate
                      ).toLocaleString()}
                    </div>
                  </div>`;
            });
            $("#messageListContainer").html(messageList);
          },
          error: function (xhr, status, error) {
            console.error("AJAX 요청 오류:", status, error);
          },
        });
      }
    </script>
  </head>
  <body>

    <!-- 네비게이션 구역 -->
    <div class="navigationContainer">

      <!-- 로고 -->
      <div class="logo">
          <a href="/">
              <img src="/images/logo3.png" class="logoImg">
          </a>
      </div>

      <!-- 우리는 -->
      <div class="projectInfo">
          <span class="highlighterBlue">
              <a href="/info/service">우리는</a>
          </span>
      </div>

      <!-- 나눠요 -->
      <div class="projectInfo">
          <span class="highlighterBlue">
              <a href="/share/list">나눠요</a>
          </span>
          
      </div>

      <!-- 버려요 -->
      <div class="projectInfo">
          <span class="highlighterBlue">
            <a href="/recycle/list">버려요</a>
          </span>
      </div>

      <!-- 오른쪽 정렬 -->
      <div class="rightGroup">

          <!-- 로그인을 안했을 시 -->
          <th:block sec:authorize="not isAuthenticated()">
              <div class="join">
                <span class="highlighterGreen">
                  <a href="/member/join">회원가입</a>
                </span>
              </div>

              <div class="login">
                <span class="highlighterGreen">
                  <a href="/member/loginForm">로그인</a>
                </span>
              </div>
          </th:block>
          
      
          <!-- 로그인을 했을 시 -->
          <th:block sec:authorize="isAuthenticated()">
              
              <!-- 쪽지 -->
              <div class="message" id="messages" th:data-num="${#authentication.principal.num}">
                  <!-- 쪽지 이미지  -->
                  <img src="/images/post.png" class="postImage">
                  <!-- 아래 뱃지 숫자는 알아서 변경하도록,,, -->
                  <div class="badge" id="badge">3</div>
              </div>

              <!-- 쪽지 목록 모달 -->
              <div
                id="messagesModal"
                class="modal"
                style="
                  max-height: calc(100vh - 50px);
                  overflow-x: hidden;
                  overflow-y: auto;
                "
              >
                <div class="modal-content">
                  <span id="messagesClose" class="close">&times;</span>
                  <h2>나눔 이야기</h2>
                  <div id="messageListContainer"></div>
                </div>
              </div>

              <!-- 쪽지 상세보기 모달 -->
              <div
                id="detailsModal"
                class="modal"
                style="
                  max-height: calc(100vh - 50px);
                  overflow-x: hidden;
                  overflow-y: auto;
                "
              >
                <div class="modal-content">
                  <span id="detailsClose" class="close">&times;</span>
                  <h2>쪽지 상세보기</h2>

                  <!-- 게시글로 이동하는 영역 추가 -->
                  <div id="goToShareBoard" style="cursor: pointer">
                    <div
                      id="shareBoardLink"
                      style="
                        padding: 10px;
                        border: 1px solid #ccc;
                        text-align: center;
                      "
                    >
                      게시글로 이동
                    </div>
                  </div>
                  <div id="messageDetailsContainer"></div>
                  <textarea
                    id="messageInput"
                    placeholder="메시지를 입력하세요"
                  ></textarea>
                  <button id="sendMessageBtn">보내기</button>
                  <button id="userReportBtn">신고하기</button>
                  <button id="shareComplete" style="display: none">
                    나눔 완료
                  </button>
                </div>
              </div>

              <!-- 게시글 유저 신고 모달창 -->
              <div id="reportModal" class="modal">
                <div class="modal-content">
                  <span class="close">&times;</span>
                  <h2>신고하기</h2>
                  <form id="reportForm">
                    <div>
                      <label
                        ><input
                          type="checkbox"
                          name="reportReason"
                          value="욕설, 인신공격 등 언어적 폭력"
                        />
                        욕설, 인신공격 등 언어적 폭력</label
                      >
                      <label
                        ><input
                          type="checkbox"
                          name="reportReason"
                          value="부적절한 게시글"
                        />
                        부적절한 게시글</label
                      >
                      <label
                        ><input
                          type="checkbox"
                          name="reportReason"
                          value="사기 또는 허위정보"
                        />
                        사기 또는 허위정보</label
                      >
                      <label
                        ><input type="checkbox" name="reportReason" value="기타" />
                        기타</label
                      >
                    </div>
                    <textarea
                      id="additionalReason"
                      placeholder="기타 사유를 입력하세요"
                    ></textarea
                    ><br />
                    <button type="button" id="submitUserReportBtn">
                      신고 제출
                    </button>
                  </form>
                </div>
              </div>
              
              <!-- 마이페이지  -->
              <div class="mypage">
                <span class="highlighterGreen">
                  <a th:href="@{/myPage/view}">마이페이지</a>
                </span>
              </div>
              
              <!-- 로그아웃 -->
              <div class="logout">
                <span class="highlighterGreen">
                  <a th:href="@{/member/logout}">로그아웃</a>
                </span>
              </div>
          </th:block>
      </div>
  </div>

  <!-- 공백 -->
  <div class="blankContainer"></div>

  <!-- mainContainer -->
  <div id="mainContainer">

    <div class="slide">
        
        <!-- 첫번째 슬라이드 -->
        <div class="slide_content">
            <div class="realContent">
                <!-- 설정에 따라 변경되는 css -->
                <div class="mainMessage" >
                    <span id="mainMessage">잘 나누고, 잘 버려요! 에코나비와 함께!</span>
                </div>
                <!-- GIF 영역 -->
                <div class="gifArea">
                    <!-- gif 이미지 -->
                    <img class="gif" src="/images/GIF.png">
                </div>
            </div>
        </div>

        <!-- 두번째 슬라이드 -->
        <div class="slide_content">
            <div class="realContent">
                <h2>인기 게시글 영역</h2>
            </div>
        </div>

        <!-- 세번째 슬라이드 -->
        <div class="slide_content">
            <div class="realContent">
                <img src="/images/map.png">
            </div>
        </div>

    </div>
    <!-- slide -->


    <!-- 좌우 버튼 -->
    <div class="arrowLeft">〈</div>
    <div class="arrowRight">〉</div>


    <!-- 페이징 (동그라미) -->
    <ul class="pagination">
        <li class="dot active" data-index="0"></li>
        <li class="dot" data-index="1"></li>
        <li class="dot" data-index="2"></li>
    </ul>


    
</div>
<!-- mainContainer -->

  </body>
</html>
