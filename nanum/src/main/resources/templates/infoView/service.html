<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>에코나비</title>

    <!-- Style -->
    <link rel="stylesheet" href="/css/info/service.css">

    <!-- script -->
    <script th:src="@{/js/jquery-3.7.1.min.js}"></script>
    <script th:src="@{/js/info/service.js}"></script>
</head>
<body>

    <!-- 네비게이션 구역 -->
    <div class="navigationContainer">

        <!-- 로고 -->
        <div class="logo">
            <a href="/">
                <img src="/images/logo.png" class="logoImg">
            </a>
        </div>

        <!-- 우리는 -->
        <div class="projectInfo">
            <span class="highlighterBlue">
                <a href="/info/service">우리는</a>
            </span>
        </div>

        <!-- 나눠요 -->
        <div class="projectInfo">
            <span class="highlighterBlue">
                <a href="/share/list">나눠요</a>
            </span>
            
        </div>

        <!-- 버려요 -->
        <div class="projectInfo">
            <span class="highlighterBlue">
                <a href="/recycle/list">버려요</a>
              </span>
        </div>

        <!-- 오른쪽 정렬 -->
        <div class="rightGroup">

            <!-- 로그인을 안했을 시 -->
            <th:block sec:authorize="not isAuthenticated()">
                <div class="join">
                  <span class="highlighterGreen">
                    <a href="/member/join">회원가입</a>
                  </span>
                </div>
  
                <div class="login">
                  <span class="highlighterGreen">
                    <a href="/member/loginForm">로그인</a>
                  </span>
                </div>
            </th:block>
            
        
            <!-- 로그인을 했을 시 -->
            <th:block sec:authorize="isAuthenticated()">
                
                <!-- 쪽지 -->
                <div class="message" id="messages" th:data-num="${#authentication.principal.num}">
                    <!-- 쪽지 이미지  -->
                    <img src="/images/post.png" class="postImage">
                    <!-- 아래 뱃지 숫자는 알아서 변경하도록,,, -->
                    <div class="badge" id="badge">0</div>
                </div>
  
                <!-- 쪽지 목록 모달 -->
                <div
                  id="messagesModal"
                  class="modal"
                  style="
                    max-height: calc(100vh - 5vh);
                    overflow-x: hidden;
                    overflow-y: auto;
                  "
                >
                <div class="modal-content">
                  <!-- 나눔 이야기 상단 영역 -->
                  <div class="messageUpside">
                    <h2>나눔 이야기</h2>
                    <!-- 닫기 버튼 -->
                    <span id="messagesClose" class="close">╳</span> 
                  </div>
                  <!-- 쪽지방 목록이 출력되는 곳 -->
                  <div id="messageListContainer"></div>
                </div>
                </div>
  
                <!-- 쪽지 상세보기 모달 -->
                <div
                  id="detailsModal"
                  class="modal"
                  style="
                    max-height: calc(100vh - 5vh);
                    overflow-x: hidden;
                    overflow-y: auto;
                  "
                >
                  <div class="modal-content">
                    <div class="messageUpside">
                      <div class="usernameContainer">
                        <img id="receiverProfileImage" src="" alt="Profile" style="width: 3vh; height: 3vh; border-radius: 50%; vertical-align: middle;"/> 
                        <span class="usernameTitle"><b id="receiverNickname"></b>님에게</span>
                        <!-- 신고하기 버튼 (공백 유지) -->
                        <span id="userReportBtn" class="userReportButton highlighterRed">신고하기</span>                      
                      </div>
                      <!-- 닫기 버튼 -->
                      <span id="detailsClose" class="close">╳</span> 
                    </div>
  
                    <!-- 게시글로 이동하는 영역 추가 -->
                    <div id="goToShareBoard" style="cursor: pointer">
                      <div
                        id="shareBoardLink"
                        style="
                          padding: 1vh 1vw;
                          border: 1px solid #ccc;
                          text-align: center;
                        "
                      >
                        게시글로 이동
                      </div>
                    </div>
                    <div id="messageDetailsContainer"></div>
                <!-- 쪽지 보내기 -->
                <div id="detailContentsContainer">
                  <textarea
                  id="messageInput"
                  class="messageContents" 
                  placeholder="내용을 입력해주세요!"
                  maxlength="100"
                    ></textarea>
                    <!-- 보내기 버튼 -->
                    <button id="sendMessageBtn">보내기</button>
                    <button id="shareComplete" style="display: none; margin-left: 1vw;">
                      나눔 완료
                    </button>
                </div>
                  </div>
                </div>
  
                <!-- 게시글 유저 신고 모달창 -->
                <div id="reportModal" class="modal">
                  <div class="modal-content">
                  <!-- 신고 모달 상단 영역 -->
                  <div class="reportUpside">
                    <!-- 신고 타이틀과 신고하고자 하는 유저 닉네임을 포함하는 영역 -->
                    <div class="reportContainer">
                    <!-- 타이틀 -->
                    <span class="reportTitle">신고하기</span>
                    <!-- 신고하기 버튼 (공백 유지) -->
                    <span id="reportUser" class="reportUser">닉네임 님</span>
                    </div>
                    <!-- 닫기 버튼 -->
                    <span class="close">╳</span>
                  </div>

                  <form id="reportForm" class="reportArea">
                    <div>
                      <label class="reportReason"
                      ><input
                      type="radio"
                      name="reportReason"
                      value="욕설, 인신공격 등 언어적 폭력"
                      />
                      욕설, 인신공격 등 언어적 폭력</label
                      >
                      <br>
                      <label class="reportReason"
                      ><input
                      type="radio"
                          name="reportReason"
                          value="부적절한 게시글"
                          />
                          부적절한 게시글</label
                          >
                          <br>
                          <label class="reportReason"
                          ><input
                          type="radio"
                          name="reportReason"
                          value="사기 또는 허위정보"
                          />
                          사기 또는 허위정보</label
                          >
                          <br>
                          <label class="reportReason"
                          ><input type="radio" name="reportReason" value="기타" />
                          기타</label
                          >
                        </div>
                        <textarea
                      id="additionalReason"
                      class="additionalReason" 
                      placeholder="기타 사유를 입력하세요."
                      maxlength="400"
                    ></textarea
                    ><br />
                    <button type="button" id="submitUserReportBtn" class="reportSubmit">
                      신고 제출
                    </button>
                  </form>
                  </div>
                </div>

                <!-- 마이페이지  -->
                <div class="mypage">
                    <span class="highlighterGreen">
                      <a th:href="@{/myPage/view}">마이페이지</a>
                    </span>
                  </div>
                  
                <!-- 로그아웃 -->
                <div class="logout">
                    <span class="highlighterGreen">
                      <a th:href="@{/member/logout}">로그아웃</a>
                    </span>
                </div>
            </th:block>
        </div>
    </div>


    <!-- 공백 -->
    <div class="blankContainer"></div>


    <!-- 고정된 박스들 -->
    <div class="box text1">
        잘 나누고
    </div>

    <div class="box hr1"></div>

    <div class="box text2">
        잘 버리는
    </div>

    <div class="box greenBox"></div>

    <div class="box text3">
        소소부터 시작하는 지구 지킴이,
        <br>
        에코나비와 함께해요!
    </div>

    <div class="image hello1">
        <img src="/images/장갑_왼쪽.png">
    </div>

    <div class="image hello2">
        <img src="/images/장갑_오른손.png">
    </div>

    <div class="box text4">
        안녕하세요!
    </div>

    <div class="image eco1">
        <img src="/images/logo.png">
    </div>

    <div class="box text5">
        나눔을 통해 가치를 잇는
        <br>
        에코나비입니다!
    </div>

    <div class="box text6">
        에코나비, 이렇게 이용하세요!
    </div>

    <div class="box text7">
        #나눠요
    </div>

    <div class="image share1">
        <img src="/images/옷.png">
    </div>

    <div class="image share2">
        <img src="/images/키보드.png">
    </div>

    <div class="image share3">
        <img src="/images/인형.png">
    </div>

    <div class="image share4">
        <img src="/images/목장갑.png">
    </div>

    <div class="image share5">
        <img src="/images/신발.png">
    </div>

    <div class="image share6">
        <img src="/images/책.png">
    </div>

    <div class="box text8">
        집에 잠들어 있지만,
        <br>
        아직 사용할 수 있는 물건들을
    </div>

    <div class="box text9">
        나눔을 통해 다시 깨울 수 있어요!
    </div>

    <div class="image sharePost1">
        <img src="/images/posting1.png">
    </div>
    
    <div class="image sharePost2">
        <img src="/images/posting2.png">
    </div>
    
    <div class="image sharePost3">
        <img src="/images/posting3.png">
    </div>
    
    <div class="image sharePost4">
        <img src="/images/posting4.png">
    </div>

    <div class="box2 text10">
        에코나비를 통해 나눔이 진행되고 있는 모습입니다:>
    </div>

    <!-- 지도 섹션 시작 -->
    <section id="map-section">
        <!-- 지도를 표시할 영역 -->
        <div id="map" class="box map"></div>
        <!-- Kakao Map API 스크립트 추가 -->
        <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=488efa68a7500b0e2b513a8253d1f0c9&libraries=clusterer"></script>
        <!-- 지도 관련 스크립트 시작 -->
        <script>
            // 지도 표시를 위한 JavaScript 코드

            // 지도를 표시할 div와 옵션 설정
            let mapContainer = document.getElementById('map'), // 지도를 표시할 div
                mapOption = { 
                    center: new kakao.maps.LatLng(33.450701, 126.570667), // 지도의 중심좌표
                    level: 7 // 지도의 확대 레벨
                };

            // 지도를 생성합니다
            let map = new kakao.maps.Map(mapContainer, mapOption); 

            // 마커 클러스터러를 생성합니다 (지도에 표시할 마커 배열을 비워둠)
            let clusterer = new kakao.maps.MarkerClusterer({
                map: map, // 마커들을 클러스터로 관리할 지도 객체
                averageCenter: true, // 클러스터의 중심을 마커들의 평균 좌표로 설정
                minLevel: 4, // 최소 레벨로 클러스터링을 적용
                disableClickZoom: false // 클러스터 클릭 시 확대하는 기본 동작을 비활성화
            });
            // 내 위치 가져오기
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        let lat = position.coords.latitude; // 위도
                        let lon = position.coords.longitude; // 경도
                        let locPosition = new kakao.maps.LatLng(lat, lon);
                        console.log(lat, lon, locPosition);
                        // 지도 중심을 내 위치로 이동
                        map.setCenter(locPosition);
                    },
                    function(error) {
                        switch (error.code) {
                            case error.PERMISSION_DENIED:
                                alert("주소창의 ! 버튼을 눌려 위치 정보를 동의해 주세요.");
                                break;
                            case error.POSITION_UNAVAILABLE:
                                alert("위치 정보를 사용할 수 없습니다.");
                                break;
                            case error.TIMEOUT:
                                alert("위치 정보를 가져오는 데 시간이 초과되었습니다.");
                                break;
                            case error.UNKNOWN_ERROR:
                                alert("알 수 없는 오류가 발생했습니다.");
                                break;
                        }
                    }
                );
            } else {
                alert("Geolocation을 지원하지 않는 브라우저입니다.");
            }


            // 마커를 저장할 배열
            let markers = [];
            let openInfoWindow = null; // 열린 인포윈도우를 추적

            // 지도에 이벤트 등록 (idle, dragend, zoom_changed)
            kakao.maps.event.addListener(map, 'idle', function () {
                triggerAjax(); // idle 이벤트 발생 시 마커를 불러옵니다.
                kakao.maps.event.removeListener(map, 'idle'); // 중복 실행 방지
            });

            kakao.maps.event.addListener(map, 'dragend', function() {
                triggerAjax(); // 지도 드래그 종료 시 마커 업데이트
            });

            kakao.maps.event.addListener(map, 'zoom_changed', function() {
                triggerAjax(); // 지도 줌 변경 시 마커 업데이트
            });

            // 지도 영역 내의 게시글을 불러오는 AJAX 함수
            function triggerAjax() {
                // 지도의 현재 영역을 가져옵니다.
                let bounds = map.getBounds();
                let swLat = bounds.getSouthWest().getLat(); // 남서쪽 위도
                let swLng = bounds.getSouthWest().getLng(); // 남서쪽 경도
                let neLat = bounds.getNorthEast().getLat(); // 북동쪽 위도
                let neLng = bounds.getNorthEast().getLng(); // 북동쪽 경도

                // 데이터에 위도, 경도 정보를 담습니다.
                let data = {swLat: swLat, swLng: swLng, neLat: neLat, neLng: neLng};

                // AJAX 요청을 보냅니다.
                $.ajax({
                    url: '/share/serviceList',
                    type: 'get',
                    data: data,
                    success: function(mapList) {
                        // 기존 마커와 클러스터를 초기화합니다.
                        clusterer.clear();
                        markers = [];

                        // 마커를 생성하고 배열에 저장합니다.
                        mapList.forEach(function(share) {
                            let markerPosition = new kakao.maps.LatLng(share.shareLat, share.shareLng);

                            // 마커 중복 확인 후 생성
                            if (!isMarkerExists(markerPosition)) {
                                let marker = new kakao.maps.Marker({
                                    position: markerPosition
                                });
                                marker.setMap(map);    // 마커를 지도에 표시합니다.
                                markers.push(marker);  // 마커를 배열에 추가합니다.

                                // 마커에 인포윈도우와 이벤트를 등록합니다.
                                createMarkerWithDynamicInfo(marker, share);
                            }
                        });

                        // 클러스터러에 마커를 추가합니다.
                        clusterer.addMarkers(markers);
                        removeMarkersOutOfBounds(); // 경계 밖 마커 제거
                    }              
                });
            }

             // ****************마커에 동적 인포윈도우를 매치, 마커에 이벤트 등록 *****************
             function createMarkerWithDynamicInfo(marker, share) {
                kakao.maps.event.addListener(marker, 'mouseover', function () {
                    let iwContent = `
                        <div class="mapInfo">
                          <div class="markerPostName">${share.shareTitle}</div>
                          <div class="markerUserName">${share.memberNickname}</div>
                          <div class="markerImage">
                            <img style="width:12vw;" src="/share/download?imageNum=${share.imageList[0].imageNum}">
                          </div>
                        </div>
                    `;

                    // 인포윈도우 생성
                    let infoWindow = new kakao.maps.InfoWindow({
                        content: iwContent,
                        disableAutoPan: true
                    });

                    // 인포윈도우 열기
                    if (openInfoWindow) {
                        openInfoWindow.close();  // 기존 열린 인포윈도우가 있으면 닫기
                    }
                    infoWindow.open(map, marker);
                    openInfoWindow = infoWindow;
                });

                // 마커에 마우스아웃 이벤트를 등록
                kakao.maps.event.addListener(marker, 'mouseout', function () {
                    if (openInfoWindow) {
                        openInfoWindow.close();
                    }
                    openInfoWindow = null;
                });

                // 마커 클릭 시 해당 게시글로 이동
                // kakao.maps.event.addListener(marker, 'click', function () {
                //     window.location.href = '/share/read?shareNum=' + share.shareNum;
                // });
            }

            // 마커 중복 여부를 확인하는 함수
            function isMarkerExists(position) {
                return markers.some(function(marker) {
                    let markerPosition = marker.getPosition();
                    return markerPosition.getLat() === position.getLat() && markerPosition.getLng() === position.getLng();
                });
            }

            // 지도 경계 밖의 마커를 제거하는 함수
            function removeMarkersOutOfBounds() {
                let bounds = map.getBounds(); // 지도의 현재 경계를 가져옵니다.

                // 경계 밖의 마커를 필터링하여 제거합니다.
                markers = markers.filter(function(marker) {
                    let position = marker.getPosition();
                    if (bounds.contain(position)) {
                        return true;  // 경계 안에 있으면 유지
                    } else {
                        marker.setMap(null);  // 지도에서 제거
                        return false; // 배열에서 제거
                    }
                });

                // 클러스터러를 업데이트합니다.
                clusterer.clear();
                clusterer.addMarkers(markers);
            }

            // 지도 이벤트에 마커 제거 함수를 등록합니다.
            kakao.maps.event.addListener(map, 'dragend', removeMarkersOutOfBounds);
            kakao.maps.event.addListener(map, 'zoom_changed', removeMarkersOutOfBounds);
        </script>
        <!-- 지도 관련 스크립트 끝 -->
    </section>
    <!-- 지도 섹션 끝 -->

    <div class="box text11">
        위치 서비스를 통해
        <br>
        나와 가까운 곳에서부터
        <br>
        가치를 이어가 보는 것은 어떤가요?
    </div>

    <div class="box2 text12">
        에코나비를 통해 나눔이 진행된 현황입니다:>
    </div>

    <div class="image share7">
        <img src="/images/쓰레기통.png">
    </div>

    <div class="image share8">
        <img src="/images/box.png">
    </div>

    <div class="image share9">
        <img src="/images/인형.png">
    </div>

    <div class="image share10">
        <img src="/images/옷.png">
    </div>

    <div class="image share11">
        <img src="/images/키보드.png">
    </div>

    <div class="image share12">
        <img src="/images/신발.png">
    </div>

    <div class="image share13">
        <img src="/images/목장갑.png">
    </div>

    <div class="image share14">
        <img src="/images/책.png">
    </div>

    <div class="box text13">
        "나눠요" 서비스를 통해
        <br>
        잠들어있는 가치를 다시 깨워 봅시다!
    </div>

    <div class="box hr2"></div>

    <div class="box text14">
        #버려요
    </div>

    <div class="image trash1">
        <img src="/images/목장갑.png">
    </div>

    <div class="image trash2">
        <img src="/images/캔.png">
    </div>

    <div class="image trash3">
        <img src="/images/페트병.png">
    </div>

    <div class="image trash4">
        <img src="/images/구겨진 종이.png">
    </div>

    <div class="image trash5">
        <img src="/images/종이컵.png">
    </div>

    <div class="image trash6">
        <img src="/images/건전지.png">
    </div>

    <div class="image trash7">
        <img src="/images/쓰레기통.png">
    </div>

    <div class="image trash8">
        <img src="/images/우산.png">
    </div>

    <div class="box text15">
        일반 쓰레기?
    </div>

    <div class="box text16">
        재활용?
    </div>

    <div class="box text17">
        이대로 버려도 되나?
    </div>

    <div class="box text18">
        재활용 쓰레기인지,
        <br>
        일반 쓰레기인지...
    </div>

    <div class="box text19">
        어떻게 버려야 제대로 버리는 것인지
        <br>
        궁금했던 적, 없으셨나요?
    </div>

    <div class="image trash9">
        <img src="/images/버려요.png">
    </div>

    <div class="box text20">
        "버려요" 서비스를 통해 알아보세요!
    </div>

    <div class="image trash10">
        <img src="/images/버려요_상세.png">
    </div>

    <div class="box text21">
        어디에, 어떻게 버리면 되는지,
        <br>
        무엇을 신경쓰면 되는지까지
    </div>

    <div class="box text22">
        에코나비가 알려드립니다!
    </div>

    <div class="box dot1"></div>

    <div class="box dot2"></div>

    <div class="box dot3"></div>

    <div class="box dot4"></div>

    <div class="box dot5"></div>

    <div class="box dot6"></div>

    <div class="box text23">
        에코나비와 함께
        <br>
        가장 가까운 곳에서부터
        <br>
        지구 지키기를 함께 해요!
    </div>

    <div class="image trash11">
        <img src="/images/지구.png">
    </div>

    <div class="box text24">
        나와 가까운 나눔 플랫폼
    </div>

    <div class="image trash12">
        <img src="/images/logo.png">
    </div>

    <div class="box text25">
        팀 상하이
    </div>

    <div class="box3 member1">
        <img src="/images/상하.png">
        <br>
        <span class="name">이상하 <span class="roll">조장</span></span>
        <br><br>
        <span class="roll">
            데이터베이스 담당
            <br>
            회원정보 처리
            <br>
            "나눔 이야기" 구현
        </span>
    </div>

    <div class="box3 member2">
        <img src="/images/용원.png">
        <br>
        <span class="name">권용원</span>
        <br><br>
        <span class="roll">
            데이터 수집
            <br>
            "버려요" 구현
        </span>
    </div>

    <div class="box3 member3">
        <img src="/images/재현.png">
        <br>
        <span class="name">김재현</span>
        <br><br>
        <span class="roll">
            프로젝트 기획 정리
            <br>
            문서화
            <br>
            데이터 수집
            <br>
            시스템 테스트
            <br>
            팀원 서포트
        </span>
    </div>

    <div class="box3 member4">
        <img src="/images/혜리.png">
        <br>
        <span class="name">김혜리</span>
        <br><br>
        <span class="roll">
            웹 디자인 및 구현
            <br>
            프론트엔드
        </span>
    </div>

    <div class="box3 member5">
        <img src="/images/현영.png">
        <br>
        <span class="name">오현영</span>
        <br><br>
        <span class="roll">
            "마이페이지" 구현
            <br>
            더미 데이터 생성
        </span>
    </div>

    <div class="box3 member6">
        <img src="/images/연규.png">
        <br>
        <span class="name">황연규</span>
        <br><br>
        <span class="roll">
            "홈" 구현
            <br>
            "이메일 인증" 구현
            <br>
            "나눠요" 구현
            <br>
            기술적 구현 서포트
            <br>
            프론트엔드 서포트
            <br>
            시스템 테스트 및 디버깅
        </span>
    </div>


    <!-- 저작권 정보 -->
    <div class="rightContainer">
        © 2024 Team San, Hai. All rights reserved.
    </div>
    
    
</body>
</html>