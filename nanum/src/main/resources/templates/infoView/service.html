<!DOCTYPE html>
<html lang="ko"
    xmlns:th="http://thymeleaf.org"
    xmlns:sec="http://thymeleaf.org/extras/spring-security"
>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>에코나비 - 환경 보호 플랫폼</title>
    <script th:src="@{/js/jquery-3.7.1.min.js}"></script>
    <script>
        // 여기에 기존의 JavaScript 코드를 유지하세요
    </script>
    <style>
        /* 간단한 스타일 추가 (필요 시 프론트엔드 개발자와 협업하여 CSS를 분리하세요) */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        header, nav, main, footer {
            padding: 20px;
            margin: 10px;
        }
        header {
            background-color: #4CAF50;
            color: white;
            text-align: center;
        }
        nav {
            background-color: #f2f2f2;
            text-align: center;
        }
        nav a {
            margin: 0 15px;
            text-decoration: none;
            color: #333;
        }
        section {
            margin-bottom: 40px;
        }
        h2 {
            color: #4CAF50;
        }
        .map-container {
            width: 100%;
            height: 70vh;
            margin-bottom: 40px;
        }
    </style>
</head>
<body>
    <!-- 헤더 섹션 -->
    <header>
        <h1>환경을 지키는 실천, 우리가 함께합니다</h1>
        <p>물품 나눔과 올바른 분리수거 정보를 제공하여 일상 속에서 환경 보호를 실천할 수 있는 기회를 제공합니다.</p>
    </header>

    <!-- 내비게이션 바 -->
    <nav>
        <a href="#project-intro">프로젝트 소개</a>
        <a href="#service-features">서비스 기능</a>
        <a href="#team">팀원 소개</a>
        <a href="#value">서비스의 가치</a>
        <a href="#faq">FAQ</a>
        <a href="#contact">문의하기</a>
    </nav>

    <!-- 메인 콘텐츠 -->
    <main>
        <!-- 프로젝트 소개 섹션 -->
        <section id="project-intro">
            <h2>팀 프로젝트 소개</h2>
            <p><strong>환경 보호 플랫폼</strong>은 저희 팀의 혁신적인 아이디어로 탄생한 지속 가능한 미래를 위한 디지털 솔루션입니다. 나눔과 분리수거의 가치를 극대화하여, 일상 속 작은 실천이 큰 변화를 이끌어낼 수 있는 서비스를 제공합니다.</p>
            
            <h3>플랫폼의 주요 목표</h3>
            <ul>
                <li><strong>자원 순환의 가치 재발견</strong>: 나눔을 통해 물건을 재사용하고 환경 보호를 실천합니다.</li>
                <li><strong>올바른 분리수거</strong>: 정확한 분리수거 정보를 제공하여 지속 가능한 생활을 돕습니다.</li>
                <li><strong>지역 기반 서비스</strong>: 나눔 게시판과 지도를 통해 지역 커뮤니티와 협력하여 자원 순환을 촉진합니다.</li>
            </ul>
        </section>

        <!-- 서비스 기능 섹션 -->
        <section id="service-features">
            <h2>서비스 기능</h2>
            
            <h3>1. 버려요</h3>
            <p>환경 보호는 올바른 분리수거에서 시작됩니다. <strong>버려요</strong> 기능은 사용자가 물품을 검색하고, 올바른 분리수거 방법을 제공합니다.</p>
            <ul>
                <li><strong>검색 기능</strong>: 버리려는 물품의 분리수거 규정과 분류 방법을 손쉽게 검색할 수 있습니다.</li>
                <li><strong>카테고리별 분리수거 정보</strong>: 전자제품, 플라스틱, 종이 등 다양한 물품별 분리수거 방법을 한눈에 확인할 수 있습니다.</li>
                <li><strong>지속적인 업데이트</strong>: 분리수거 규정은 최신 정보로 자동 업데이트되어 항상 정확한 정보를 제공합니다.</li>
            </ul>

            <h3>2. 나눠요</h3>
            <p>쓸모없는 물건이지만, 누군가에게는 유용한 자원이 될 수 있습니다. <strong>나눠요</strong> 기능을 통해 물건을 기부하거나 필요한 물품을 무료로 나눔받을 수 있습니다.</p>
            <ul>
                <li><strong>지역 기반 나눔</strong>: 사용자 위치를 기반으로 가까운 지역에서 나눔을 실천할 수 있습니다.</li>
                <li><strong>지도를 활용한 나눔 게시글</strong>: 지도에 나눔 장소를 표시하여, 주변의 나눔 활동을 쉽게 확인하고 참여할 수 있습니다.</li>
                <li><strong>커뮤니티와의 소통</strong>: 나눔을 통해 환경을 보호하면서, 지역 사회와 소통할 수 있습니다.</li>
            </ul>

            <h3>3. 마이페이지</h3>
            <p>개인 맞춤형 환경 관리 시스템입니다. 나눔 내역을 확인하고, 쓰레기 배출일을 설정하며, 나만의 친환경 생활을 관리할 수 있습니다.</p>
            <ul>
                <li><strong>프로필 관리</strong>: 닉네임, 비밀번호, 이메일을 손쉽게 변경할 수 있으며, 수정 시 유효성 검사를 거칩니다.</li>
                <li><strong>나눔 기록 확인</strong>: 내가 나눔한 물품, 받은 물품, 북마크한 내역을 한눈에 확인할 수 있습니다.</li>
                <li><strong>배출일 알림</strong>: 쓰레기 배출 요일을 설정하면, 배출일에 맞춘 알림 서비스가 제공됩니다.</li>
            </ul>
        </section>

        <!-- 지도 섹션 -->
        <section id="map-section">
            <h2>나눔 장소 지도</h2>
            <div id="map" class="map-container"></div>
        </section>

        <!-- 팀원 소개 섹션 -->
        <section id="team">
            <h2>팀원 소개</h2>
            <ul>
                <li><strong>상하</strong>: 팀장, 버려요/마이페이지 기능 담당 개발자. 서비스 전반의 기능 구현과 상하이 햄버거를 담당합니다.</li>
                <li><strong>현영</strong>: 버려요/마이페이지 기능 개발 담당. 상하이와 함께 빅맥 개발 및 유지 보수를 담당합니다.</li>
                <li><strong>용원</strong>: 중국어 번역을 담당하며, 나눠요 기능 개발자. 글로벌 사용자를 위한 언어 지원과 기능 개발을 맡고 있습니다.</li>
                <li><strong>연규</strong>: 나눠요 기능 서프라이즈 개발자. 위치 기반 나눔 기능을 설계하고 사용자 인터페이스를 최적화합니다.</li>
                <li><strong>혜리</strong>: 서비스 전반 디자인 담당. 마블 히어로 이미지와 버려요 관련 그래픽 디자인을 제작하여 서비스의 비주얼 아이덴티티를 담당합니다.</li>
                <li><strong>재현</strong>: 프로젝트 제안서 작성 및 서비스 효과 분석 담당. 프로젝트 발표 준비 및 간식을 총괄합니다.</li>
            </ul>
        </section>

        <!-- 서비스의 가치 섹션 -->
        <section id="value">
            <h2>서비스의 가치</h2>
            <ul>
                <li><strong>지속 가능한 미래</strong>: 일상 속 작은 실천이 환경을 보호할 수 있는 큰 변화로 이어집니다.</li>
                <li><strong>사용자 편의성 극대화</strong>: 누구나 쉽고 편리하게 사용할 수 있는 직관적인 UI/UX 설계를 통해 모든 사용자가 환경 보호에 참여할 수 있습니다.</li>
                <li><strong>커뮤니티 활성화</strong>: 지역 기반의 나눔을 통해 이웃과의 소통을 활성화하고, 지속 가능한 커뮤니티를 형성합니다.</li>
            </ul>
        </section>

        <!-- FAQ 섹션 -->
        <section id="faq">
            <h2>자주 묻는 질문 (FAQ)</h2>
            <dl>
                <dt>1. 회원가입 시 필요한 정보는 무엇인가요?</dt>
                <dd>회원가입을 위해서는 아이디, 비밀번호, 닉네임, 이메일 정보가 필요합니다. 이메일 인증을 통해 안전하게 회원가입을 진행할 수 있습니다.</dd>

                <dt>2. 나눔은 어떻게 이루어지나요?</dt>
                <dd>사용자의 위치를 기반으로, 나눔하고자 하는 물품을 올리고, 다른 사용자가 이를 받을 수 있도록 연결해줍니다.</dd>

                <dt>3. 분리수거 정보를 제공하나요?</dt>
                <dd>네, 검색 기능을 통해 다양한 물품의 분리수거 방법과 규정을 쉽게 찾을 수 있으며, 최신 정보를 지속적으로 업데이트합니다.</dd>
            </dl>
        </section>

        <!-- 문의하기 섹션 -->
        <section id="contact">
            <h2>문의하기</h2>
            <p>서비스에 대한 궁금증이 있으시다면 <a href="#faq">FAQ 페이지</a>를 참조하시거나, 고객센터에 문의해 주세요.</p>
            <ul>
                <li><strong>고객센터 전화</strong>: 010-3016-8935</li>
                <li><strong>이메일</strong>: <a href="mailto:support@greenplatform.com">jaehyeon8935@naver.com</a></li>
            </ul>
        </section>
    </main>

    <!-- 푸터 섹션 -->
    <footer>
        <p>&copy; 2024 에코나비 - 환경 보호 플랫폼. All rights reserved.</p>
    </footer>

    <!-- js로 지도 불러오기 -->
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=488efa68a7500b0e2b513a8253d1f0c9&libraries=clusterer"></script>
    <!-- 지도 script -->
    <script>
        let mapContainer = document.getElementById('map'), // 지도를 표시할 div 
            mapOption = { 
                center: new kakao.maps.LatLng(33.450701, 126.570667), // 지도의 중심좌표
                level: 7 // 지도의 확대 레벨
            };

        // 지도를 생성합니다
        let map = new kakao.maps.Map(mapContainer, mapOption); 

        // 마커 클러스터러를 생성 (지도에 표시할 마커 배열을 비워둠)
        let clusterer = new kakao.maps.MarkerClusterer({
            map: map, // 마커들을 클러스터로 관리할 지도 객체
            averageCenter: true, // 클러스터의 중심을 마커들의 평균 좌표로 설정
            minLevel: 4, // 최소 레벨로 클러스터링을 적용
            disableClickZoom: false // 클러스터 클릭 시 확대하는 기본 동작을 비활성화
        });

        //내위치 가져오기
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                let lat = position.coords.latitude; // 위도
                let lon = position.coords.longitude; // 경도
                let locPosition = new kakao.maps.LatLng(lat, lon);
                console.log(lat, lon, locPosition);
                // 지도 중심을 내 위치로 이동
                map.setCenter(locPosition);
            });
        } else {
            alert("Geolocation을 지원하지 않는 브라우저입니다.");
        }

        //마커를 저장할 배열 
        let markers = [];
        let openInfoWindow = null;  // 열린 인포윈도우 추적

        // ************* 지도에 이벤트 등록 ****************************************************************
        // 초기 로드 시 마커를 불러오기 위해 'idle' 이벤트를 사용
        kakao.maps.event.addListener(map, 'idle', function () {
            triggerAjax();  // idle 이벤트가 발생하면 마커를 불러옵니다.
            kakao.maps.event.removeListener(map, 'idle');  // 한 번 실행 후 제거하여 중복 실행 방지
        });

        // 드래그가 끝난 후 발생하는 'dragend' 이벤트를 사용하여 Ajax 요청을 실행
        kakao.maps.event.addListener(map, 'dragend', function() {
            triggerAjax();
        });

        // 확대/축소가 끝난 후 발생하는 'zoom_changed' 이벤트를 사용하여 Ajax 요청을 실행
        kakao.maps.event.addListener(map, 'zoom_changed', function() {
            triggerAjax();
        });
        //**********************지도에 이벤트를 등록 ***************************************************

        // **************지도 영역내의 게시글을 불러오는 ajax*******************************************
        function triggerAjax() {
            //지도의 영역을 불러온다. 
            let bounds = map.getBounds();
            let swLat = bounds.getSouthWest().getLat(); // 남서쪽 위도
            let swLng = bounds.getSouthWest().getLng(); // 남서쪽 경도
            let neLat = bounds.getNorthEast().getLat(); // 북동쪽 위도
            let neLng = bounds.getNorthEast().getLng(); // 북동쪽 경도

            // data에 위도, 경도, 검색정보를 담기
            let data = {swLat: swLat, swLng: swLng, neLat: neLat, neLng: neLng}

            //지도 영역이 변할때마다 ajax를 실행시킨다.
            $.ajax({
                url: '/share/serviceList',
                type: 'get',
                data: data, //남서 북서 끝단의 위도 경도 정보를 보낸다. 
                //성공시 반복문을 사용하여 마커들을 지도상에 찍어준다. 
                success: function(mapList) {
                    // 기존 마커를 제거하고 클러스터러에서 삭제
                    clusterer.clear(); // ajax가 실행될때마다 클러스터를 비우지 않으면 클러스터에 마커가 계속 쌓인다
                    
                    // 마커 배열을 초기화
                    markers = []; // ajax가 실행할때마다 배열을 초기화하고 다시 마커들을 찍어 배열에 저장한다.

                    // 지도에 마커를 찍어 게시글 위치를 표시
                    mapList.forEach(function(share) {
                        let markerPosition = new kakao.maps.LatLng(share.shareLat, share.shareLng);

                        // 마커 중복확인 함수 isMarkerExists가 false일때 실행 (마커가 이미 있으면 true를 반환한다.)
                        if (!isMarkerExists(markerPosition)) {
                            let marker = new kakao.maps.Marker({
                                position: markerPosition
                            });
                            marker.setMap(map);    // marker를 지도에 표시합니다.
                            markers.push(marker);  // marker를 markers 배열에 넣는다.

                            // 각 마커에 대한 인포윈도우와 이벤트 등록
                            createMarkerWithInfo(marker, share);
                        }
                    });
                    
                    // 클러스터러에 새로 추가된 마커들 등록
                    clusterer.addMarkers(markers);
                    removeMarkersOutOfBounds(); // 경계 밖 마커 제거
                }              
            });
        };
        //***************************지도 영역내의 게시글을 불러오는 ajax**************************************

        // ****************마커에 인포윈도우를 매치, 마커에 이벤트 등록 *****************
        function createMarkerWithInfo(marker, share) {
            let iwContent = `
                <div style="padding:5px; width:110px; height:150px;">
                    <span>${share.shareTitle}</span><br>
                    <span>${share.memberNickname}</span>
                    <img style="width:100px; height:100px;" src="/share/download?imageNum=${share.imageList[0].imageNum}">
                </div>
            `;

            // 인포윈도우를 생성합니다
            let infoWindow = new kakao.maps.InfoWindow({
                content: iwContent,
                disableAutoPan: true // 자동 이동 비활성화
            });

            // 마커에 마우스오버 이벤트를 등록합니다
            kakao.maps.event.addListener(marker, 'mouseover', function () {
                // 다른 인포윈도우가 열려 있으면 먼저 닫습니다
                if (openInfoWindow) {
                    openInfoWindow.close();
                }
                // 인포윈도우를 마커 위에 표시
                infoWindow.open(map, marker);
                openInfoWindow = infoWindow;  // 열린 인포윈도우를 저장
            });

            // 마커에 마우스아웃 이벤트를 등록합니다
            kakao.maps.event.addListener(marker, 'mouseout', function () {
                // 마우스아웃 이벤트가 발생하면 인포윈도우를 닫습니다
                infoWindow.close();
                openInfoWindow = null;  // 열린 인포윈도우를 없앰
            });

        }
        //*************************마커에 인포윈도우를 매치, 마커에 이벤트 등록 ********************************

        //***********************기타함수***********************************
        // 좌표를 기반으로 중복 마커 확인하는 함수
        function isMarkerExists(position) {
            return markers.some(function(marker) {
                let markerPosition = marker.getPosition();
                return markerPosition.getLat() === position.getLat() && markerPosition.getLng() === position.getLng();
            });
        }
        
        // 지도 경계 밖 마커를 삭제하는 함수
        function removeMarkersOutOfBounds() {
            let bounds = map.getBounds(); // 지도의 현재 경계 가져오기
            
            //filter함수를 사용하여 마커배열을 순회해 경게 안에 있으면 유지, 없으면 삭제 
            markers = markers.filter(function(marker) {
                let position = marker.getPosition();
                // 마커가 경계 안에 있으면 유지, 경계 밖이면 지도에서 제거
                if (bounds.contain(position)) {
                    return true;  // 경계 안에 있는 마커는 유지
                } else {
                    marker.setMap(null);  // 경계 밖의 마커는 지도에서 제거
                    return false;  // markers 배열에서 삭제
                }
            });

            // 클러스터러에 경계 안의 마커들만 다시 추가
            clusterer.clear(); // 기존 클러스터 삭제
            clusterer.addMarkers(markers); // 클러스터에 남은 마커 다시 추가
        }

        // 지도가 이동되거나 줌이 변경될 때 경계 밖 마커 제거
        kakao.maps.event.addListener(map, 'dragend', removeMarkersOutOfBounds);
        kakao.maps.event.addListener(map, 'zoom_changed', removeMarkersOutOfBounds);
        //*********************기타함수*****************************************************
    </script>
</body>
</html>
